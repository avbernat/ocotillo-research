---
title: "Ocotillo Morphology Summary Statistics"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
rm(list=ls())

library(ggplot2)
library(olsrr)

library(FactoMineR)
library(factoextra)
library(readr)
library(corrplot)

dir = "/Users/anastasiabernat/Desktop/ocotillo_research/modeling_octform/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```

# Multivariate Modeling of Ocotillo Morphology

## Reading and Cleaning the Data

```{r}
source("src/cleaning_data.R")
source("src/regression_output.R")
output_col = FALSE

all_data = clean_data("data/General_Oco_Data.csv", "data/End_Segments_5segs.csv")

ocos = all_data[[2]]
ocos_baj = ocos[ocos$Plant[1:20],]

str(ocos)
```

## Diagnostic Plot Function

```{r}
plot_diagnostic = function(m, d) {
  
  d['fitted_values'] = m$fitted.values
  d['fitted_residuals'] = m$residuals
  
  plot = ggplot(data = d) + geom_point(aes(x = fitted_values, y = fitted_residuals)) +
  geom_hline(yintercept = 0) +
  labs(title = "Plot of Fitted Residuals against Fitted Values",
       x = "Fitted Values", y = "Fitted Residuals") 
  
  print(ols_test_normality(m))
  
  return(plot)
}
```


## Height 

### All Ocos

**Testing Covariates**

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lm(logHeight ~ Elevation_c, data=ocos)
m2 = lm(Height_c ~ site, data=ocos)
m3 = lm(logHeight ~ site, data=ocos)
m4 = lm(Height_c ~ TSeg_c, data=ocos)
m5 = lm(logHeight ~ TSeg_c, data=ocos)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col)
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col)
```

**Make Diagnostic Plots**

When the response variable is log transformed, residuals are independent.

```{r}
plot_diagnostic(m1, ocos)
#plot_diagnostic(m2, ocos) # categorical covariate
#plot_diagnostic(m3, ocos) # categorical covariate
plot_diagnostic(m4, ocos)
plot_diagnostic(m5, ocos)
```

**Model Comparisons**

**site, Elevation_c, TSeg_c**

```{r}
data<-data.frame(
  R=ocos$logHeight,
  A=ocos$site,
  B=ocos$Elevation_c, 
  C=ocos$TSeg_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
cor(ocos$site, ocos$Elevation_c)
```

Elevation and site were highly correlated (R = -0.85), which leads to multicollinearity. Interactions between site and elevation were removed. This eliminates m11 and m15 as the top models

```{r}
anova(m7, m13, test='Chisq') # adding B*C does not improve fit
anova(m5, m7, test='Chisq') # Adding B does not improve fit
anova(m4, m7, test='Chisq') # Adding C does improve fit
anova(m1, m4, test='Chisq') # Adding B does not improve fit
anova(m3, m5, test='Chisq') # Adding C does improve fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m5, ocos)
plot_diagnostic(m7, ocos)
plot_diagnostic(m4, ocos)
# plot_diagnostic(m1, ocos) # categorical covariate
plot_diagnostic(m3, ocos)
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m5) - AIC(m5))
delta2 = abs(AIC(m5) - AIC(m7))
delta3 = abs(AIC(m5) - AIC(m4))
delta4 = abs(AIC(m5) - AIC(m1))
delta5 = abs(AIC(m5) - AIC(m3))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)
me5 <- exp( -0.5 * delta5)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4, me5))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
weight5 = me5 / (sum)
```

```{r}
summary_table = round(cbind(c(AIC(m5), AIC(m7), AIC(m4), AIC(m1), AIC(m3)),
                                  c(delta1, delta2, delta3, delta4, delta5), 
                                  c(me1, me2, me3, me4, me5), 
                                  c(weight1, weight2, weight3, weight4, weight5)), 3)
summary_table
```

```{r}
tidy_regression(m5, output_col) 
tidy_regression(m7, output_col) 
tidy_regression(m4, output_col)
tidy_regression(m1, output_col)
tidy_regression(m3, output_col)
```

### Bajada Ocos

**Testing Covariates**

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lm(Height_c ~ TSeg_c, data=ocos_baj)
m2 = lm(logHeight ~ TSeg_c, data=ocos_baj)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
```

**Model Comparisons**

**Elevation_c, TSeg_c**

```{r}
data<-data.frame(
  R=ocos_baj$logHeight,
  A=ocos_baj$Elevation_c,
  B=ocos_baj$TSeg_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 2-FF.R")
```

```{r}
anova(m0, m2, test="Chisq") # Adding B does improve fit
anova(m0, m1, test="Chisq") # Adding A does not improve fit
anova(m2, m3, test="Chisq") # Adding A does not improve fit
anova(m3, m4, test="Chisq") # Adding A*B does not improve fit
```

```{r}
tidy_regression(m2, output_col)
tidy_regression(m3, output_col)
tidy_regression(m4, output_col)
tidy_regression(m1, output_col)
tidy_regression(m0, output_col)
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m2, ocos_baj)
plot_diagnostic(m3, ocos_baj)
plot_diagnostic(m4, ocos_baj)
plot_diagnostic(m1, ocos_baj)
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m2) - AIC(m2))
delta2 = abs(AIC(m2) - AIC(m3))
delta3 = abs(AIC(m2) - AIC(m4))
delta4 = abs(AIC(m2) - AIC(m1))
delta5 = abs(AIC(m2) - AIC(m0))


me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)
me5 <- exp( -0.5 * delta5)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4, me5))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
weight5 = me5 / (sum)
```

```{r}
summary_table = round(cbind(c(AIC(m2), AIC(m3), AIC(m4), AIC(m1), AIC(m0)),
                            c(delta1, delta2, delta3, delta4, delta5), 
                            c(me1, me2, me3, me4, me5), 
                            c(weight1, weight2, weight3, weight4, weight5)), 3)
summary_table
```

Only factor that largely influences ocotillo height is terminal segment length.

## Circumference

### All Ocos 

**Testing Covariates**

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lm(Circ_c ~ NBranch_c, data=ocos)
m2 = lm(logCirc ~ NBranch_c, data=ocos)
m3 = lm(logCirc ~ X1m_Num4, data=ocos) # Although significant, this is not a meaningful number in this context.

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col) 
tidy_regression(m3, output_col) 
```

**Plot diagnostics**

All pass. Residuals are independent.

```{r}
plot_diagnostic(m1, ocos)
plot_diagnostic(m2, ocos)
plot_diagnostic(m3, ocos)
```
**Model Comparisons**

Null model was the top model for all other combinations of covariates except this combination:

**NBranches, site**

```{r}
data<-data.frame(
  R=ocos$logCirc,
  A=ocos$NBranch_c,
  B=ocos$site)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 2-FF.R")
```

```{r}
anova(m1, m3, test='Chisq') # Adding B does not improve fit
anova(m0, m1, test='Chisq') # Adding A does improve fit
anova(m0, m2, test='Chisq') # Adding B does not improve fit
```

```{r}
tidy_regression(m1, output_col) 
tidy_regression(m0, output_col) 
tidy_regression(m2, output_col)
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m1, ocos)
plot_diagnostic(m0, ocos)
plot_diagnostic(m2, ocos)
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m1) - AIC(m1))
delta2 = abs(AIC(m1) - AIC(m0))
delta3 = abs(AIC(m1) - AIC(m2))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
```

```{r}
summary_table = round(cbind(c(AIC(m1), AIC(m0), AIC(m2)),
                            c(delta1, delta2, delta3), 
                            c(me1, me2, me3), 
                            c(weight1, weight2, weight3)),3)
summary_table
```

### Bajada Ocotillos

**Testing Covariates**

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lm(Circ_c ~ NBranch_c, data=ocos_baj)
m2 = lm(logCirc ~ NBranch_c, data=ocos_baj)
m3 = lm(logCirc ~ X1m_Num4, data=ocos_baj) # AB: although significant is this a meaningful number? 

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col) 
tidy_regression(m3, output_col) 
```

**Plot diagnostics**

All pass. Residuals are independent.

```{r}
plot_diagnostic(m1, ocos_baj)
plot_diagnostic(m2, ocos_baj)
plot_diagnostic(m3, ocos_baj)
```

**Model Comparisons**

Null model was the top model for all other combinations of covariates except this combination:

**NBranches, site, X1m_Num4**

```{r}
data<-data.frame(
  R=ocos_baj$logCirc,
  A=ocos_baj$NBranch_c,
  B=ocos_baj$X1m_Num4) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 2-FF.R")
```

```{r}
anova(m2, m3, test="Chisq") # Adding A does improve fit
anova(m1, m3, test="Chisq") # Adding B does improve fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m1, ocos_baj)
plot_diagnostic(m2, ocos_baj)
plot_diagnostic(m3, ocos_baj) # but did this pass?
plot_diagnostic(m4, ocos_baj) # but did this pass?
```

Conclusion: Same top model as the all ocotillos model comparisons. Which is lm(formula = logCirc ~ NBranch_c, data = data)

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m1) - AIC(m1))
delta2 = abs(AIC(m1) - AIC(m0))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
```

```{r}
summary_table = round(cbind(c(delta1, delta2), c(me1, me2), c(weight1, weight2)),3)
summary_table
```

## Number of Branches

### All Ocos

**Testing Covariates** 

Only significant covariates are listed below:

```{r}
m1 = lm(NBranch_c ~ Circ_c, data=ocos)
m2 = lm(logNB ~ Circ_c, data=ocos)
m3 = lm(NBranch_c ~ Watershed_c, data=ocos)
m4 = lm(logNB ~ Watershed_c, data=ocos)
m5 = lm(logNB ~ COMP_dis_c, data=ocos)
m6 = lm(NBranch_c ~ COMP_plant_b, data=ocos)
m7 = lm(logNB ~ COMP_plant_b, data=ocos)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col) 
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col) # marginally significant
tidy_regression(m6, output_col) 
tidy_regression(m7, output_col)  
```


**Plot Diagnostics**

All except NBranch ~ Circ passed. However, when the response variable is log transformed, the models pass - residuals are independent.

```{r}
plot_diagnostic(m1, ocos) # did not pass 
plot_diagnostic(m2, ocos) 
plot_diagnostic(m3, ocos) 
plot_diagnostic(m4, ocos)
plot_diagnostic(m5, ocos)
#plot_diagnostic(m6, ocos) # categorical covariate
#plot_diagnostic(m7, ocos) # categorical covariate
```

**Model Comparisons**

Null model was the top model for all other combinations of covariates except this combination:

**Circ, COMP_plant_b, COMP_distance, Watershed**

```{r}
data<-data.frame(
  R=ocos$logNB,
  A=ocos$Circ_c,
  B=ocos$COMP_plant_b, 
  C=ocos$COMP_dis_c,
  D=ocos$Watershed_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 4-FF.R")
```

```{r}
anova(m13, m32, test='Chisq') # Adding C*D does not improve fit
anova(m13, m15, test='Chisq') # Adding B does not improve fit
anova(m7, m13, test='Chisq') # Adding C marginally improves fit
anova(m10, m13, test='Chisq') # Adding A improves fit
anova(m6, m13, test='Chisq') # Adding D improves fit

# top models are m13, m10, m7, m5, and m6
```

```{r}
tidy_regression(m13, output_col) # A + C + D
tidy_regression(m10, output_col) # C + D | Add A
tidy_regression(m7, output_col) # A + D | Add C
tidy_regression(m5, output_col)
tidy_regression(m6, output_col) # A + C | Add D
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m13, ocos)
plot_diagnostic(m10, ocos)
plot_diagnostic(m7, ocos)
plot_diagnostic(m5, ocos)
plot_diagnostic(m6, ocos)
```


**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m13) - AIC(m13))
delta2 = abs(AIC(m13) - AIC(m7))
delta3 = abs(AIC(m13) - AIC(m6))
delta4 = abs(AIC(m13) - AIC(m5))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```

```{r}
summary_table = round(cbind(c(AIC(m13), AIC(m7), AIC(m6), AIC(m5)),
                            c(delta1, delta2, delta3, delta4), 
                            c(me1, me2, me3, me4), 
                            c(weight1, weight2, weight3, weight4)),3)
summary_table
```

### Bajada Ocos

**Testing Covariates** 

Only significant covariates are listed below:

```{r}
m1 = lm(NBranch_c ~ Circ_c, data=ocos_baj)
m2 = lm(logNB ~ Circ_c, data=ocos_baj)
m3 = lm(NBranch_c ~ Watershed_c, data=ocos_baj)
m4 = lm(logNB ~ Watershed_c, data=ocos_baj)
m5 = lm(logNB ~ COMP_dis_c, data=ocos_baj)
m7 = lm(NBranch_c ~ Elevation_c, data=ocos_baj)
m7 = lm(logNB ~ Elevation_c, data=ocos_baj)
m8 = lm(NBranch_c ~ Watershed_c, data=ocos_baj)
m9 = lm(logNB ~ Watershed_c, data=ocos_baj)
m10 = lm(NBranch_c ~ X1m_CID_type1, data=ocos_baj)
m11 = lm(logNB ~ X1m_CID_type1, data=ocos_baj)
m12 = lm(NBranch_c ~ NN_c, data=ocos_baj)
m13 = lm(logNB ~ NN_c, data=ocos_baj)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col) 
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col) 
tidy_regression(m6, output_col)  
tidy_regression(m7, output_col) 
tidy_regression(m8, output_col) 
tidy_regression(m9, output_col) 
tidy_regression(m10, output_col) 
tidy_regression(m11, output_col) 
tidy_regression(m12, output_col) 
tidy_regression(m13, output_col) 
```

**Plot Diagnostics**

When the response variable is log transformed, the models passed except for m13 which was lm(logNB ~ NN_c, data=ocos_baj).

```{r}
ocos_baj_s = ocos_baj[complete.cases(ocos_baj$X1m_CID_type1),]
plot_diagnostic(m1, ocos_baj) 
plot_diagnostic(m2, ocos_baj) 
plot_diagnostic(m3, ocos_baj) 
plot_diagnostic(m4, ocos_baj)
plot_diagnostic(m5, ocos_baj)
#plot_diagnostic(m6, ocos_baj) # categorical covariate
plot_diagnostic(m7, ocos_baj) 
plot_diagnostic(m8, ocos_baj) 
plot_diagnostic(m9, ocos_baj) 
#plot_diagnostic(m10, ocos_baj_s) # categorical covariate
#plot_diagnostic(m11, ocos_baj_s) # categorical covariate
plot_diagnostic(m12, ocos_baj) 
plot_diagnostic(m13, ocos_baj) # did not pass
```
**Model Comparisons**

**Elevation, Circ, Nearest Neighbor**

```{r}
data<-data.frame(
  R=ocos_baj$logNB,
  A=ocos_baj$Elevation_c,
  B=ocos_baj$Circ_c, 
  C=ocos_baj$NN_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m13, m15, test="Chisq") # Adding A*B marginally improves fit
anova(m10, m13, test="Chisq") # Adding A marginally improves fit
anova(m6, m10, test="Chisq") # Adding B*C improves fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m3, m6, test="Chisq") # Adding B does improve fit
anova(m2, m6, test="Chisq") # Adding C does improve fit
```

```{r}
tidy_regression(m10, output_col)
tidy_regression(m13, output_col) 
tidy_regression(m6, output_col) 
tidy_regression(m7, output_col) 
tidy_regression(m2, output_col) 
tidy_regression(m3, output_col) 
```

**Watershed, Circ, Nearest Neighbor**

```{r}
data<-data.frame(
  R=ocos_baj$logNB,
  A=ocos_baj$Watershed_c,
  B=ocos_baj$Circ_c, 
  C=ocos_baj$NN_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m13, m15, test="Chisq") # Adding A*B marginally improves fit
anova(m10, m13, test="Chisq") # Adding A does not improve fit
anova(m6, m10, test="Chisq") # Adding B*C improves fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m3, m6, test="Chisq") # Adding B does improve fit
anova(m2, m6, test="Chisq") # Adding C does improve fit
```

```{r}
tidy_regression(m10, output_col)
tidy_regression(m13, output_col) 
tidy_regression(m6, output_col) 
tidy_regression(m7, output_col) 
tidy_regression(m2, output_col) 
tidy_regression(m3, output_col) 
```

**COMP_plant_b, Circ, Nearest Neighbor**

```{r}
data<-data.frame(
  R=ocos_baj$logNB,
  A=ocos_baj$COMP_plant_b,
  B=ocos_baj$Circ_c, 
  C=ocos_baj$NN_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m13, m15, test="Chisq") # Adding A*B does improve fit
anova(m10, m13, test="Chisq") # Adding A marginally improves fit
anova(m6, m10, test="Chisq") # Adding B*C does improve fit
```

```{r}
tidy_regression(m15, output_col) 
tidy_regression(m17, output_col) 
tidy_regression(m13, output_col) 
tidy_regression(m10, output_col)
tidy_regression(m6, output_col) 
```

**Comparing best fits**

```{r}
m0 = lm(logNB ~ Circ_c * NN_c + COMP_plant_b + Watershed_c, ocos_baj)
m1 = lm(logNB ~ Circ_c * NN_c + COMP_plant_b + Elevation_c, ocos_baj)
m2 = lm(logNB ~ Circ_c * NN_c + COMP_plant_b, ocos_baj)
m3 =lm(logNB ~ Circ_c * NN_c + Elevation_c, ocos_baj)
m4 = lm(logNB ~ Circ_c * NN_c + Watershed_c, ocos_baj)
m5 = lm(logNB ~ Circ_c * NN_c, ocos_baj)
m6 = lm(logNB ~ Circ_c + NN_c, ocos_baj)
m7 = lm(logNB ~ Circ_c, ocos_baj)
m8 = lm(logNB ~ NN_c, ocos_baj)
```

```{r}
anova(m2, m1, test="Chisq") # Adding Elevation_c does not improve fit
anova(m2, m0, test="Chisq") # Adding Watershed_c does not improve fit
```

```{r}
AIC(m2)
AIC(m1)
AIC(m5)
AIC(m0)
AIC(m3)
AIC(m4) 
AIC(m6)
AIC(m7)
AIC(m8)
```

```{r}
tidy_regression(m2, output_col) # top model
```

**Plot diagnostics**

All passed except m8. Residuals are independent.

```{r}
plot_diagnostic(m2, ocos_baj)
plot_diagnostic(m1, ocos_baj)
plot_diagnostic(m5, ocos_baj)
plot_diagnostic(m0, ocos_baj)
plot_diagnostic(m3, ocos_baj)
plot_diagnostic(m4, ocos_baj)
plot_diagnostic(m6, ocos_baj)
plot_diagnostic(m7, ocos_baj)
plot_diagnostic(m8, ocos_baj) # does not pass confidently
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

# top models are m13, m7, and m6, m10

delta1 = 0 # abs(AIC(m13) - AIC(m13))
delta2 = abs(AIC(m2) - AIC(m1))
delta3 = abs(AIC(m2) - AIC(m5))
delta4 = abs(AIC(m2) - AIC(m0))
delta5 = abs(AIC(m2) - AIC(m3))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)
me5 <- exp( -0.5 * delta5)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4, me5))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
weight5 = me5 / (sum)
```

```{r}
summary_table = round(cbind(c(delta1, delta2, delta3, delta4, delta5), c(me1, me2, me3, me4, me5), c(weight1, weight2, weight3, weight4, weight5)),3)
summary_table
```

# Mixed Effect Modeling of Ocotillo Terminal Segments

## Reading and Cleaning the Data

```{r}
rm(list=ls())

source("src/cleaning_data.R")
source("src/regression_output.R")
output_col = FALSE

all_data = clean_data("data/General_Oco_Data.csv", "data/End_Segments_5segs.csv")

seg_baj = all_data[[1]][[1]]
seg_organ = all_data[[1]][[2]] 
segs = all_data[[1]][[3]]

segs <- segs[!is.na(segs$Length_c),]
str(segs)
segs
```

**Testing Covariates**

Dropped branch_num as a random factor to better help the model fit the data.

Only significant covariates are listed below (most are marginal in this case):

```{r echo=FALSE}
m1 = lmer(Length_c ~ Height_c + (1|Tree) + (1|seg_num), data=segs)
m2 = lmer(Length_c ~ T1m_NumNonshrub + (1|Tree) + (1|seg_num), data=segs) 
m3 = lmer(Length_c ~ R1m_shrub2non + (1|Tree) + (1|seg_num), data=segs)

# lmer(Length_c ~ X1m_type2 + (1|Tree) + (1|seg_num), data=segs) also significant but it does not answer our question on how the number and types of small competitors affect terminal segment length.

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col)
```

**Make Diagnostic Plots**

```{r}
plot_diagnostic = function(m, d) {
  
  d['fitted_values'] = fitted(m)
  d['fitted_residuals'] = residuals(m)
  
  plot = ggplot(data = d) + geom_point(aes(x = fitted_values, y = fitted_residuals)) +
  geom_hline(yintercept = 0) +
  labs(title = "Plot of Fitted Residuals against Fitted Values",
       x = "Fitted Values", y = "Fitted Residuals") 
  
  return(plot)
}
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
temp_segs = segs[complete.cases(segs$R1m_shrub2non),]

plot_diagnostic(m1, segs)
plot_diagnostic(m2, segs)
plot_diagnostic(m3, temp_segs)
plot_diagnostic(m4, temp_segs)
```


**Model Comparisons**

**Height, T1m_NumNonshrub, R1m_shrub2non**

```{r}
data<-data.frame(
  R=segs$Length_c,
  A=segs$Height_c, 
  B=segs$T1m_NumNonshrub, 
  C=segs$R1m_shrub2non,
  X=segs$Tree,
  Y=segs$seg_num)

# Fit the models to the same number of observations by filtering out NA values:
data <- data[complete.cases(data),]

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lmer 2 RF-3FF.R")
model_comparisonsAIC("src/generic models-gaussian glmer 2-RF + 3-FF REMLF.R")
```

```{r}
anova(m4, m7, test="Chisq") # Adding C does not improve fits
anova(m1, m4, test="Chisq") # Adding B does not improve fit
anova(m1, m5, test="Chisq") # Adding C does not improve fit
anova(m4, m8, test="Chisq") # Adding A*B does not improve fit
anova(m0, m1, test="Chisq") # Adding A does improve fit
```

```{r}
tidy_regression(m4, output_col)
tidy_regression(m1, output_col)
tidy_regression(m5, output_col)
tidy_regression(m0, output_col)
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m4, data)
plot_diagnostic(m1, data)
plot_diagnostic(m5, data)
plot_diagnostic(m0, data)
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

# top models are m13, m7, and m6, m10

delta1 = 0 # abs(AIC(m4) - AIC(m4))
delta2 = abs(AIC(m4) - AIC(m1))
delta3 = abs(AIC(m4) - AIC(m5))
delta4 = abs(AIC(m4) - AIC(m0))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```

```{r}
summary_table = round(cbind(c(delta1, delta2, delta3, delta4), c(me1, me2, me3, me4), c(weight1, weight2, weight3, weight4)),3)
summary_table
```


## Principal Component Analysis (PCA)

**Reading the Data**

```{r}
growthForm <- read.csv("data/growthForm.csv", row.names = 1)
```

**Investigating Variables**

```{r}
GFpca <- PCA(growthForm, scale.unit = TRUE, graph = TRUE, ncp = 10)

eig.val <- get_eigenvalue(GFpca)
eig.val
fviz_eig(GFpca, addlabels = TRUE, ylim = c(0, 50))
```

An eigenvalue > 1 indicates that PCs account for more variance than accounted by one of the original variables in standardized data. This is commonly used as a cutoff point for which PCs are retained. This holds true only when the data are standardized, which we have done.

You can also limit the number of component to that number that accounts for a certain fraction of the total variance. (No formal cut-off)

```{r}
variables <- get_pca_var(GFpca)
corrplot(variables$cos2, is.corr=FALSE)

corrplot(variables$contrib, is.corr=FALSE)

GFdim <- dimdesc(GFpca, axes = c(1,2), proba = 0.05)
GFdim$Dim.1
GFdim$Dim.2
```

**Plot by Competitor**

- Ask Acacia about this one:

```{r}
#Plot by competitor
Groupings <- read_csv("data/Groupings.csv")
growthForm$Competitor <- Groupings$Watershed_Dis
fviz_pca_ind(GFpca,
             geom.ind = "text",
             col.ind = growthForm$Competitor,
             legend.title = "Distance to Watershed",
)

```


