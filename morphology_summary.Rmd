---
title: "Ocotillo Morphology Summary Statistics"
author: "Anastasia Bernat"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
rm(list=ls())

library(ggplot2)
library(olsrr)
library(lme4)

library(tidyverse)
library(ggpubr)
library(rstatix)

library(FactoMineR)
library(factoextra)
library(readr)
library(corrplot)

dir = "/Users/anastasiabernat/Desktop/git_repositories/ocotillo-research/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```


# Multivariate Modeling of Ocotillo Morphology

Analyses below are multivariate models of Fouquieria splendens morphology for ocotillos located on both a bajada and a plain in Organ Pipe National Monument, Arizona. All models were grouped by their response variable and ordered by their ascending AIC values. Dataset "ocos" indicates all individuals measured on the bajada and plain while "ocos_baj" indicates only the individuals measured on the bajada. Ocotillos located on the bajada were encoded with site = 0 while ocotillos on the plain were encoded with site = 1. Interspecific neighbor group is split between two types – shrub and cactus – where cactus = 0 and shrub = 1. 

## Reading and Cleaning the Data

```{r}
source("src/cleaning_data.R")
source("src/regression_output.R")
output_col = FALSE

all_data = clean_data("data/General_Oco_Data2.csv", "data/Terminal_5Segs.csv")

ocos = all_data[[2]]
ocos_baj = ocos[1:20,]
segs = all_data[[1]]
seg_baj = segs[1:1000,] 
```

## Functions

```{r}
### Diagnostic Plot Function

plot_diagnostic = function(m, d) {
  # m:  model generated by lm() or glm()
  # d:  data as a data.frame object
  
  d['fitted_values'] = m$fitted.values
  d['fitted_residuals'] = m$residuals
  
  plot = ggplot(data = d) + geom_point(aes(x = fitted_values, y = fitted_residuals)) +
  geom_hline(yintercept = 0) +
  labs(title = "Plot of Fitted Residuals against Fitted Values",
       x = "Fitted Values", y = "Fitted Residuals") 
  
  print(ols_test_normality(m))
  
  return(plot)
}
```


```{r}
### Renaming Regression Formulas Function

rename_regformula = function (eqs, response_var, predA, predB, predC, predD) {
  # eqs:              list of linear regression formals as characters
  # response_var:     response variable as a character
  # predA:            predictor variable A as a character
  # predB:            predictor variable B as a character
  # predC:            predictor variable C as a character
  # predD:            predictor variable D as a character
  for (i in 1:length(eqs)) {
  if (grepl(" C", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("C", predC, eqs[i])
  }
  if (grepl(" A", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("A", predA, eqs[i])
  }
  if (grepl(" B", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("B", predB, eqs[i])
  }
  if (grepl(" D", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("D", predD, eqs[i])
  }
  if (grepl( "R", eqs[i], fixed = TRUE)) {
    eqs[i] = gsub("R", response_var, eqs[i])
  }
  }
  return(eqs)
}
```

## Normality

All measurements followed log-normal distributions except for circumference, median branch length, number of nodes, and distance to the nearest arroyo, which were normally distributed. Ocotillo data were log-transformed before analyses to meet assumptions of normality, linear regressions, and homogeneity for parametric analyses.

## Height 

### Outlier Case

When model comparisons are conducted with the full ocos dataset, the best fit model includes site and terminal segment length IQR as predictors to logHeight. However, terminal segment length IQR has an outlier - Ocotillo 1 (see graphs.Rmd). In turn, the outlier was removed and logHeight is predicted with a smaller dataset containing all ocotillos except Ocotillo 1.

```{r}
ocos = ocos[-1,]
n_height = nrow(ocos)

# center variables
ocos$TSegIQR_c = ocos$Terminal_SegIQR - mean(ocos$Terminal_SegIQR, na.rm=TRUE)
ocos$BL_IQR_c = ocos$BranchLength_IQR - mean(ocos$BranchLength_IQR, na.rm=TRUE)
ocos$Median_BL_c = ocos$Median_BranchLength - mean(ocos$Median_BranchLength, na.rm=TRUE)
ocos$NumNodes_c = ocos$Num_Nodes - mean(ocos$Num_Nodes, na.rm=TRUE)
```

### All Ocos

**Testing Covariates**

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lm(logHeight ~ Elevation_c, data=ocos)
m2 = lm(Height_c ~ Site, data=ocos)
m3 = lm(logHeight ~ Site, data=ocos)
m4 = lm(Height ~ Median_BL_c, data=ocos)
m5 = lm(logHeight ~ Median_BL_c, data=ocos)
m6 = lm(Height ~ NumNodes_c, data=ocos)
m7 = lm(logHeight ~ NumNodes_c, data=ocos)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col)
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col)
tidy_regression(m6, output_col)
tidy_regression(m7, output_col)
```

**Make Diagnostic Plots**

When the response variable is log transformed, residuals are independent.

```{r}
plot_diagnostic(m1, ocos)
#plot_diagnostic(m2, ocos) # categorical covariate
#plot_diagnostic(m3, ocos) # categorical covariate
plot_diagnostic(m4, ocos)
plot_diagnostic(m5, ocos)
plot_diagnostic(m6, ocos)
plot_diagnostic(m7, ocos)
```

**Model Comparisons**

**site, Elevation_c, Median_BL**

```{r}
data<-data.frame(
  R=ocos$logHeight,
  A=ocos$Site,
  B=ocos$Elevation_c, 
  C=ocos$Median_BL_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
cor(ocos$Site, ocos$Elevation_c)
```

Elevation and site were highly correlated (R = -0.85), which led to multicollinearity. In turn, we removed any interactions between elevation and site in the model comparison process in order to minimize relationships that were spurious. This eliminated m11 and m15 as the top models.

```{r}
anova(m7, m11, test="Chisq") # Adding A*B marginally improves fit
anova(m5, m7, test="Chisq") # Adding B does not improve fit
anova(m3, m5, test="Chisq") # Adding A does improve fit
anova(m1, m5, test="Chisq") # Adding C does improve fit | m5 is the best fit model
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m5, ocos)
plot_diagnostic(m7, ocos)
plot_diagnostic(m3, ocos)
# plot_diagnostic(m1, ocos) # categorical covariate
```

**Site, NumNodes_c, TSeg_c**

```{r}
data<-data.frame(
  R=ocos$logHeight,
  A=ocos$Site,
  B=ocos$NumNodes_c, 
  C=ocos$Median_BL_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```
```{r}
anova(m5, m7, test="Chisq") # Adding B does not improve fit
anova(m3, m5, test="Chisq") # Adding A improves fit
anova(m1, m5, test="Chisq") # Adding C improves fit
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m5) - AIC(m5))
delta2 = abs(AIC(m5) - AIC(m7))
delta3 = abs(AIC(m5) - AIC(m1))
delta4 = abs(AIC(m5) - AIC(m3))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```

```{r}
summary_tableH = round(cbind(c(AIC(m5), AIC(m7), AIC(m1), AIC(m3)),
                                  c(delta1, delta2, delta3, delta4), 
                                  c(me1, me2, me3, me4), 
                                  c(weight1, weight2, weight3, weight4)), 3)

eq1 = paste(m5$call)[2]
eq2 = paste(m7$call)[2]
eq3 = paste(m4$call)[2]
eq4 = paste(m1$call)[2]

equations = c(eq1, eq2, eq3, eq4)
equations = rename_regformula(equations, "logHeight", "Site", "Elevation", "Median_BranchLength")

summary_tableH = cbind(equations, summary_tableH)
colnames(summary_tableH) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
summary_tableH[2,] = gsub("Median_ElevationranchLength", "Median_BranchLength", summary_tableH[2,])
```

```{r}
summary_tableH
```

```{r}
# Best fit model summary
cf <- round(coef(m5), 3) 
eqH <- paste0("logHeight = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Site",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " Median_BranchLength")

commentH = "Site, Median_BranchLength"
rowH = cbind(eqH, commentH)
colnames(rowH) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowH
```

### t-test (Height vs. Site)

```{r}
ocos = all_data[[2]] # significant difference exists even if Plant 1 is removed
t.test(ocos$Height~ocos$Site)
t.test(ocos$logHeight~ocos$Site)
```

### Bajada Ocos

```{r}
# removing Ocotillo 1
ocos_baj = ocos_baj[-1,] 
n_height.b = nrow(ocos_baj)

# re-center variables
ocos_baj$TSegIQR_c = ocos_baj$Terminal_SegIQR - mean(ocos_baj$Terminal_SegIQR, na.rm=TRUE)
ocos_baj$BL_IQR_c = ocos_baj$BranchLength_IQR - mean(ocos_baj$BranchLength_IQR, na.rm=TRUE)
ocos_baj$Median_BL_c = ocos_baj$Median_BranchLength - mean(ocos_baj$Median_BranchLength, na.rm=TRUE)
ocos_baj$NumNodes_c = ocos_baj$Num_Nodes - mean(ocos_baj$Num_Nodes, na.rm=TRUE)
```

**Testing Covariates**

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lm(Height ~ Median_BL_c, data=ocos_baj)
m2 = lm(logHeight ~ Median_BL_c, data=ocos_baj)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
```

**Make Diagnostic Plots**

All residuals are independent.

```{r}
plot_diagnostic(m1, ocos_baj)
plot_diagnostic(m2, ocos_baj)
```

**Model Comparisons**

**NumNodes_c, Elevation_c, Median_BL_c**

```{r}
data<-data.frame(
  R=ocos_baj$logHeight,
  A=ocos_baj$NumNodes_c,
  B=ocos_baj$Elevation_c, 
  C=ocos_baj$Median_BL_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```
```{r}
anova(m3, m5, test="Chisq") # Adding A does not improve fit
anova(m3, m6, test="Chisq") # Adding B does not improve fit 
```
**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m3, ocos_baj)
plot_diagnostic(m5, ocos_baj)
plot_diagnostic(m6, ocos_baj) 
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m2) - AIC(m2))
delta2 = abs(AIC(m3) - AIC(m6))
delta3 = abs(AIC(m3) - AIC(m5))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
```

```{r}
summary_tableH.B = round(cbind(c(AIC(m3), AIC(m6), AIC(m5)),
                            c(delta1, delta2, delta3), 
                            c(me1, me2, me3), 
                            c(weight1, weight2, weight3)), 3)

eq1 = paste(m3$call)[2]
eq2 = paste(m6$call)[2]
eq3 = paste(m5$call)[2]

equations = c(eq1, eq2, eq3)
equations = rename_regformula(equations, "logHeight", "Number_Nodes", "Elevation", "Median_BranchLength")

summary_tableH.B = cbind(equations, summary_tableH.B)
colnames(summary_tableH.B) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
summary_tableH.B[2,] =  gsub("Median_ElevationranchLength", "Median_BranchLength", summary_tableH.B[2,])
```

```{r}
summary_tableH.B
```

```{r}
# Best fit model summary
cf <- round(coef(m3), 3) 
eqH.B <- paste0("logHeight = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Median_BranchLength")

commentH.B = "Median_BranchLength"
rowH.B = cbind(eqH.B, commentH.B)
colnames(rowH.B) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowH.B
```

## Circumference

```{r}
ocos = all_data[[2]] # re-reading the full dataset | no outliers here
n_circ = nrow(ocos)
```

### All Ocos 

**Testing Covariates**

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lm(Circ_c ~ NBranch_c, data=ocos)
m2 = lm(logCirc ~ NBranch_c, data=ocos)
m3 = lm(logCirc ~ X1m_Num4, data=ocos) # Although significant, this is not a meaningful number in this context.

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col) 
tidy_regression(m3, output_col) 
```

**Plot diagnostics**

All pass. Residuals are independent.

```{r}
plot_diagnostic(m1, ocos)
plot_diagnostic(m2, ocos)
plot_diagnostic(m3, ocos)
```
**Model Comparisons**

Null model was the top model for all other combinations of covariates except this combination:

**NBranches, site**

```{r}
data<-data.frame(
  R=ocos$logCirc,
  A=ocos$NBranch_c,
  B=ocos$Site)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 2-FF.R")
```

```{r}
anova(m1, m3, test='Chisq') # Adding B does not improve fit
anova(m0, m1, test='Chisq') # Adding A does improve fit
anova(m0, m2, test='Chisq') # Adding B does not improve fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m1, ocos)
plot_diagnostic(m0, ocos)
plot_diagnostic(m2, ocos)
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m1) - AIC(m1))
delta2 = abs(AIC(m1) - AIC(m0))
delta3 = abs(AIC(m1) - AIC(m2))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
```

```{r}
summary_tableC = round(cbind(c(AIC(m1), AIC(m0), AIC(m2)),
                            c(delta1, delta2, delta3), 
                            c(me1, me2, me3), 
                            c(weight1, weight2, weight3)),3)

eq1 = paste(m1$call)[2]
eq2 = paste(m0$call)[2]
eq3 = paste(m2$call)[2]

equations = c(eq1, eq2, eq3)
equations = rename_regformula(equations, "logCirc", "Num_Branch", "Site")

summary_tableC = cbind(equations, summary_tableC)
colnames(summary_tableC) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableC
```


```{r}
# Best fit model summary
cf <- round(coef(m1), 2) 
eqC <- paste0("logCirc = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Num_Branch")

commentC = "Num_Branch"
rowC = cbind(eqC, commentC)
colnames(rowC) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowC
```

### Bajada Ocotillos

```{r}
ocos_baj = ocos[1:20,]
n_circ.b = nrow(ocos_baj)
```

**Testing Covariates**

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lm(Circ_c ~ NBranch_c, data=ocos_baj)
m2 = lm(logCirc ~ NBranch_c, data=ocos_baj)
m3 = lm(logCirc ~ X1m_Num4, data=ocos_baj) # AB: although significant, this is not a significant number.

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col) 
tidy_regression(m3, output_col) 
```

**Plot diagnostics**

All pass. Residuals are independent.

```{r}
plot_diagnostic(m1, ocos_baj)
plot_diagnostic(m2, ocos_baj)
plot_diagnostic(m3, ocos_baj)
```

**Model Comparisons**

Null model was the top model for all other combinations of covariates except this combination:

**NBranches, site, X1m_Num4**

```{r}
data<-data.frame(
  R=ocos_baj$logCirc,
  A=ocos_baj$NBranch_c,
  B=ocos_baj$X1m_Num4) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 2-FF.R")
```

```{r}
anova(m2, m3, test="Chisq") # Adding A does improve fit
anova(m1, m3, test="Chisq") # Adding B does improve fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m1, ocos_baj)
plot_diagnostic(m2, ocos_baj)
plot_diagnostic(m3, ocos_baj) # but did this pass?
plot_diagnostic(m4, ocos_baj) # but did this pass?
```

Conclusion: Same top model as the all ocotillos model comparisons. Which is lm(formula = logCirc ~ NBranch_c, data = data)

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m1) - AIC(m1))
delta2 = abs(AIC(m1) - AIC(m0))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
```
  
```{r}
summary_tableC.B = round(cbind(c(AIC(m1), AIC(m0)),
                            c(delta1, delta2), c(me1, me2), 
                            c(weight1, weight2)),3)

eq1 = paste(m1$call)[2]
eq2 = paste(m0$call)[2]

equations = c(eq1, eq2)
equations = rename_regformula(equations, "logCirc", "Num_Branch", "1m_Num4")

summary_tableC.B = cbind(equations, summary_tableC.B)
colnames(summary_tableC.B) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableC.B
```


```{r}
# Best fit model summary
cf <- round(coef(m1), 2) 
eqC.B <- paste0("logCirc = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Num_Branch")

commentC.B = "Num_Branch"
rowC.B = cbind(eqC.B, commentC.B)
colnames(rowC.B) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowC.B
```

## Number of Branches

### All Ocos

```{r}
ocos = all_data[[2]]
n_branch = nrow(ocos)
```

**Testing Covariates** 

Only significant covariates are listed below:

```{r}
m1 = lm(NBranch_c ~ Circ_c, data=ocos)
m2 = lm(logNB ~ Circ_c, data=ocos)
m3 = lm(NBranch_c ~ Arroyo_c, data=ocos)
m4 = lm(logNB ~ Arroyo_c, data=ocos)
m5 = lm(logNB ~ Inter_Dis_c, data=ocos)
m6 = lm(NBranch_c ~ Inter_plant_b, data=ocos)
m7 = lm(logNB ~ Inter_plant_b, data=ocos)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col) 
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col) # marginally significant
tidy_regression(m6, output_col) 
tidy_regression(m7, output_col)  
```


**Plot Diagnostics**

All except NBranch ~ Circ passed. However, when the response variable is log transformed, the models pass - residuals are independent.

```{r}
plot_diagnostic(m1, ocos) # did not pass 
plot_diagnostic(m2, ocos) 
plot_diagnostic(m3, ocos) 
plot_diagnostic(m4, ocos)
plot_diagnostic(m5, ocos)
#plot_diagnostic(m6, ocos) # categorical covariate
#plot_diagnostic(m7, ocos) # categorical covariate
```

**Model Comparisons**

Null model was the top model for all other combinations of covariates except this combination:

**Circ_c, Inter_plant_b, Inter_Dis_c, Arroyo_Dis**

```{r}
data<-data.frame(
  R=ocos$logNB,
  A=ocos$Circ_c,
  B=ocos$Inter_plant_b, 
  C=ocos$Inter_Dis_c,
  D=ocos$Arroyo_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 4-FF.R")
```

```{r}
anova(m13, m32, test='Chisq') # Adding C*D does not improve fit
anova(m13, m15, test='Chisq') # Adding B does not improve fit
anova(m7, m13, test='Chisq') # Adding C marginally improves fit
anova(m10, m13, test='Chisq') # Adding A improves fit
anova(m6, m13, test='Chisq') # Adding D improves fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m13, ocos)
plot_diagnostic(m10, ocos)
plot_diagnostic(m7, ocos)
plot_diagnostic(m5, ocos)
plot_diagnostic(m6, ocos)
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m13) - AIC(m13))
delta2 = abs(AIC(m13) - AIC(m7))
delta3 = abs(AIC(m13) - AIC(m6))
delta4 = abs(AIC(m13) - AIC(m5))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```

```{r}
summary_tableB = round(cbind(c(AIC(m13), AIC(m7), AIC(m6), AIC(m5)),
                            c(delta1, delta2, delta3, delta4), 
                            c(me1, me2, me3, me4), 
                            c(weight1, weight2, weight3, weight4)),3)

eq1 = paste(m13$call)[2]
eq2 = paste(m7$call)[2]
eq3 = paste(m6$call)[2]
eq4 = paste(m5$call)[2]

equations = c(eq1, eq2, eq3, eq4)
equations = rename_regformula(equations, "logNumBranch", "Circ", "Inter_Plant_Group", "Inter_Dis", "Arroyo")

summary_tableB = cbind(equations, summary_tableB)
colnames(summary_tableB) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
summary_tableB[1,] = gsub("Inter_Arroyois", "Inter_Distance", summary_tableB[1,])
```

```{r}
summary_tableB 
```


```{r}
# Best fit model summary
cf <- round(coef(m13), 3) 
eqNB <- paste0("logNumBranch = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Circ",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " Inter_Distance",
             ifelse(sign(cf[4])==1, " + ", " - "), abs(cf[4]), " Arroyo_Distance")

commentNB = "Circ, Arroyo_Distance"
rowNB = cbind(eqNB, commentNB)
colnames(rowNB) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowNB
```

### Bajada Ocos

```{r}
ocos_baj = ocos[1:20,]
n_branch.b = nrow(ocos_baj)
```

**Testing Covariates** 

Only significant covariates are listed below:

```{r}
m1 = lm(NBranch_c ~ Circ_c, data=ocos_baj)
m2 = lm(logNB ~ Circ_c, data=ocos_baj)
m3 = lm(NBranch_c ~ Arroyo_c, data=ocos_baj)
m4 = lm(logNB ~ Arroyo_c, data=ocos_baj)
m5 = lm(logNB ~ Inter_Dis_c, data=ocos_baj)
m7 = lm(NBranch_c ~ Elevation_c, data=ocos_baj)
m7 = lm(logNB ~ Elevation_c, data=ocos_baj)
m8 = lm(NBranch_c ~ Arroyo_c, data=ocos_baj)
m9 = lm(logNB ~ Arroyo_c, data=ocos_baj)
m10 = lm(NBranch_c ~ X1m_CID_type1, data=ocos_baj)
m11 = lm(logNB ~ X1m_CID_type1, data=ocos_baj)
m12 = lm(NBranch_c ~ Intra_Dis_c, data=ocos_baj)
m13 = lm(logNB ~ Intra_Dis_c, data=ocos_baj)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col) 
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col) 
tidy_regression(m6, output_col)  
tidy_regression(m7, output_col) 
tidy_regression(m8, output_col) 
tidy_regression(m9, output_col) 
tidy_regression(m10, output_col) 
tidy_regression(m11, output_col) 
tidy_regression(m12, output_col) 
tidy_regression(m13, output_col) 
```

**Plot Diagnostics**

When the response variable is log transformed, the models passed except for m13 which was lm(logNB ~ NN_c, data=ocos_baj).

```{r}
ocos_baj_s = ocos_baj[complete.cases(ocos_baj$X1m_CID_type1),]
plot_diagnostic(m1, ocos_baj) 
plot_diagnostic(m2, ocos_baj) 
plot_diagnostic(m3, ocos_baj) 
plot_diagnostic(m4, ocos_baj)
plot_diagnostic(m5, ocos_baj)
#plot_diagnostic(m6, ocos_baj) # categorical covariate
plot_diagnostic(m7, ocos_baj) 
plot_diagnostic(m8, ocos_baj) 
plot_diagnostic(m9, ocos_baj) 
#plot_diagnostic(m10, ocos_baj_s) # categorical covariate
#plot_diagnostic(m11, ocos_baj_s) # categorical covariate
plot_diagnostic(m12, ocos_baj) 
plot_diagnostic(m13, ocos_baj) # did not pass
```
**Model Comparisons**

**Elevation_c, Circ_c, Intra_Dis_c**

```{r}
data<-data.frame(
  R=ocos_baj$logNB,
  A=ocos_baj$Elevation_c,
  B=ocos_baj$Circ_c, 
  C=ocos_baj$Intra_Dis_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m13, m15, test="Chisq") # Adding A*B marginally improves fit
anova(m10, m13, test="Chisq") # Adding A marginally improves fit
anova(m6, m10, test="Chisq") # Adding B*C improves fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m3, m6, test="Chisq") # Adding B does improve fit
anova(m2, m6, test="Chisq") # Adding C does improve fit
```

**Arroyo_c, Circ_c, Intra_Dis_c**

```{r}
data<-data.frame(
  R=ocos_baj$logNB,
  A=ocos_baj$Arroyo_c,
  B=ocos_baj$Circ_c, 
  C=ocos_baj$Intra_Dis_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m13, m15, test="Chisq") # Adding A*B marginally improves fit
anova(m10, m13, test="Chisq") # Adding A does not improve fit
anova(m6, m10, test="Chisq") # Adding B*C improves fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m3, m6, test="Chisq") # Adding B does improve fit
anova(m2, m6, test="Chisq") # Adding C does improve fit
```

**Inter_plant_b, Circ_c, Intra_Dis_c**

```{r}
data<-data.frame(
  R=ocos_baj$logNB,
  A=ocos_baj$Inter_plant_b,
  B=ocos_baj$Circ_c, 
  C=ocos_baj$Intra_Dis_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m13, m15, test="Chisq") # Adding A*B does improve fit
anova(m10, m13, test="Chisq") # Adding A marginally improves fit
anova(m6, m10, test="Chisq") # Adding B*C does improve fit
```

**Comparing best fits**

```{r}
m0 = lm(logNB ~ Circ_c * Intra_Dis_c + Inter_plant_b + Arroyo_c, ocos_baj)
m1 = lm(logNB ~ Circ_c * Intra_Dis_c + Inter_plant_b + Elevation_c, ocos_baj)
m2 = lm(logNB ~ Circ_c * Intra_Dis_c + Inter_plant_b, ocos_baj)
m3 =lm(logNB ~ Circ_c * Intra_Dis_c + Elevation_c, ocos_baj)
m4 = lm(logNB ~ Circ_c * Intra_Dis_c + Arroyo_c, ocos_baj)
m5 = lm(logNB ~ Circ_c * Intra_Dis_c, ocos_baj)
m6 = lm(logNB ~ Circ_c + Intra_Dis_c, ocos_baj)
m7 = lm(logNB ~ Circ_c, ocos_baj)
m8 = lm(logNB ~ Intra_Dis_c, ocos_baj)
```

```{r}
anova(m2, m1, test="Chisq") # Adding Elevation_c does not improve fit
anova(m2, m0, test="Chisq") # Adding Arroyo_c does not improve fit
```

```{r}
tidy_regression(m2, output_col) # best fit model
```

**Plot diagnostics**

All passed except m8. Residuals are independent.

```{r}
plot_diagnostic(m2, ocos_baj)
plot_diagnostic(m1, ocos_baj)
plot_diagnostic(m5, ocos_baj)
plot_diagnostic(m0, ocos_baj)
plot_diagnostic(m3, ocos_baj)
plot_diagnostic(m4, ocos_baj)
plot_diagnostic(m6, ocos_baj)
plot_diagnostic(m7, ocos_baj)
plot_diagnostic(m8, ocos_baj) # does not pass confidently
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m13) - AIC(m13))
delta2 = abs(AIC(m2) - AIC(m1))
delta3 = abs(AIC(m2) - AIC(m5))
delta4 = abs(AIC(m2) - AIC(m0))
delta5 = abs(AIC(m2) - AIC(m3))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)
me5 <- exp( -0.5 * delta5)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4, me5))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
weight5 = me5 / (sum)
```

```{r}
summary_tableB.B = round(cbind(c(AIC(m2), AIC(m1), AIC(m5), AIC(m0), AIC(m3)),
                            c(delta1, delta2, delta3, delta4, delta5), 
                            c(me1, me2, me3, me4, me5), 
                            c(weight1, weight2, weight3, weight4, weight5)),3)

eq1 = paste(m2$call)[2]
eq2 = paste(m1$call)[2]
eq3 = paste(m5$call)[2]
eq4 = paste(m0$call)[2]
eq5 = paste(m3$call)[2]

equations = c(eq1, eq2, eq3, eq4, eq5)

summary_tableB.B = cbind(equations, summary_tableB.B)
colnames(summary_tableB.B) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableB.B = gsub("logNB", "logNumBranch", summary_tableB.B)
summary_tableB.B = gsub("Circ_c", "Circ", summary_tableB.B)
summary_tableB.B = gsub("Intra_Dis_c", "Intra_Distance", summary_tableB.B)
summary_tableB.B = gsub("Inter_plant_b", "Inter_Plant_Group", summary_tableB.B)
summary_tableB.B = gsub("Elevation_c", "Elevation", summary_tableB.B)
summary_tableB.B = gsub("Arroyo_c", "Arroyo", summary_tableB.B)
```

```{r}
summary_tableB.B
```


```{r}
# Best fit model summary
cf <- round(coef(m2), 2) 
eqNB.B <- paste0("logNumBranch = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Circ",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " Intra_Distance",
             ifelse(sign(cf[4])==1, " + ", " - "), abs(cf[4]), " Inter_Plant_Group",
             ifelse(sign(cf[5])==1, " + ", " - "), abs(cf[5]), " Circ*Intra_Distance")

commentNB.B = "Circ, Circ*Intra_Distance"
rowNB.B = cbind(eqNB.B, commentNB.B)
colnames(rowNB.B) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowNB.B
```

### t-test (Number of Branches vs. Interspecific Plant Group)

```{r}
t.test(ocos$logNB~ocos$Inter_Plant_Group)
```
## Number of Nodes

### All Ocos

```{r}
ocos = all_data[[2]]
n_nodes = nrow(ocos)
```

**Testing Covariates** 

Only significant covariates are listed below:

```{r}
m1 = lm(NumNodes_c ~ Arroyo_c, data=ocos) # marginally significant 
m2 = lm(logNodes ~ Arroyo_c, data=ocos) # marginally significant
m3 = lm(NumNodes_c ~ Elevation_c, data=ocos) # site driving this relationship
m4 = lm(logNodes ~ Elevation_c, data=ocos) 
m5 = lm(NumNodes_c ~ Site, data=ocos) 
m6 = lm(logNodes ~ Site, data=ocos) 
m7 = lm(NumNodes_c ~ Median_BL_c, data=ocos) 
m8 = lm(logNodes ~ Median_BL_c, data=ocos) 

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col) 
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col)
tidy_regression(m6, output_col) 
tidy_regression(m7, output_col)
tidy_regression(m8, output_col)  
```

**Site, Median_BL_c, Elevation_c, Arroyo_c**

```{r}
data<-data.frame(
  R=ocos$logNodes,
  A=ocos$Site,
  B=ocos$Median_BL_c, 
  C=ocos$Elevation_c,
  D=ocos$Arroyo_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 4-FF.R")
```

```{r}
anova(m8, m19, test="Chisq") # Adding B*C does not improve fit
```

**Site, Median_BL_c, Elevation_c**

```{r}
data<-data.frame(
  R=ocos$logNodes,
  A=ocos$Site,
  B=ocos$Median_BL_c, 
  C=ocos$Elevation_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```
```{r}
anova(m6, m10, test="Chisq") # Adding B*C does not improve fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m2, m6, test="Chisq") # Adding C does improve fit
anova(m3, m6, test="Chisq") # Adding B does improve fit

anova(m1, m4, test="Chisq") # Adding B does not improve fit
anova(m2, m4, test="Chisq") # Adding A does improve fit
```

**Plot diagnostics**

All passed except m2 has that outlier residual. Residuals are independent.

```{r}
plot_diagnostic(m6, ocos)
plot_diagnostic(m2, ocos) 
plot_diagnostic(m3, ocos)
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m13) - AIC(m13))
delta2 = abs(AIC(m6) - AIC(m3))
delta3 = abs(AIC(m6) - AIC(m2))
delta4 = abs(AIC(m6) - AIC(m0))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```

```{r}
summary_tableNN = round(cbind(c(AIC(m6), AIC(m3), AIC(m2), AIC(m0)),
                            c(delta1, delta2, delta3, delta4), 
                            c(me1, me2, me3, me4), 
                            c(weight1, weight2, weight3, weight4)),3)

eq1 = paste(m6$call)[2]
eq2 = paste(m3$call)[2]
eq3 = paste(m2$call)[2]
eq4 = paste(m0$call)[2]

equations = c(eq1, eq2, eq3, eq4)
equations = rename_regformula(equations, "logNumNodes", "Site", "Median_BranchLength", "Elevation")

summary_tableNN = cbind(equations, summary_tableNN)
colnames(summary_tableNN) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableNN 
```

```{r}
# Best fit model summary
cf <- round(coef(m6), 3) 
eqNN <- paste0("logNumNodes = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Median_BranchLength",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " Elevation")

commentNN = "Median_BranchLength, Elevation"
rowNN = cbind(eqNN, commentNN)
colnames(rowNN) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowNN
```

### Bajada

```{r}
ocos_baj = ocos[2:20,]
n_nodes.b = nrow(ocos_baj)
```

```{r}
m1 = lm(NumNodes_c ~ BL_IQR_c, data=ocos_baj) 
m2 = lm(logNodes ~ BL_IQR_c, data=ocos_baj) 
m3 = lm(logNodes ~ TSegIQR_c, data=ocos_baj) # marginal

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col) 
```

```{r}
# center variables
ocos_baj$TSegIQR_c = ocos_baj$Terminal_SegIQR - mean(ocos_baj$Terminal_SegIQR, na.rm=TRUE)
ocos_baj$BL_IQR_c = ocos_baj$BranchLength_IQR - mean(ocos_baj$BranchLength_IQR, na.rm=TRUE)
ocos_baj$Median_BL_c = ocos_baj$Median_BranchLength - mean(ocos_baj$Median_BranchLength, na.rm=TRUE)
ocos_baj$NumNodes_c = ocos_baj$Num_Nodes - mean(ocos_baj$Num_Nodes, na.rm=TRUE)
```

**Median_BL_c, TSegIQR_c, BL_IQR_c**

```{r}
data<-data.frame(
  R=ocos_baj$logNodes,
  A=ocos_baj$Median_BL_c, 
  B=ocos_baj$TSegIQR_c,
  C=ocos_baj$BL_IQR_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
anova(m5, m7, test="Chisq") # Adding B marginally improves fit
anova(m4, m7, test="Chisq") # Adding C marginally improves fit
anova(m7, m11, test="Chisq") # Adding A*B does not improve fit
anova(m2, m4, test="Chisq") # Adding B improves fit
anova(m1, m4, test="Chisq") # Adding A improves fit
anova(m3, m5, test="Chisq") # Adding A improves fit
anova(m1, m5, test="Chisq") # ADding C improves fit
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m13) - AIC(m13))
delta2 = abs(AIC(m5) - AIC(m1))
delta3 = abs(AIC(m5) - AIC(m3))
delta4 = abs(AIC(m5) - AIC(m0))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```


```{r}
summary_tableNN.B = round(cbind(c(AIC(m5), AIC(m1), AIC(m3), AIC(m0)),
                            c(delta1, delta2, delta3, delta4), 
                            c(me1, me2, me3, me4), 
                            c(weight1, weight2, weight3, weight4)),3)

eq1 = paste(m5$call)[2]
eq2 = paste(m1$call)[2]
eq3 = paste(m3$call)[2]
eq4 = paste(m0$call)[2]

equations = c(eq1, eq2, eq3, eq4)
equations = rename_regformula(equations, "logNumNodes", "Median_BranchLength", "Terminal_SegLengthIQR", "BranchLengthIQR")

summary_tableNN.B = cbind(equations, summary_tableNN.B)
colnames(summary_tableNN.B) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableNN.B = gsub("Median_Terminal_SegLengthIQlogNumNodesranchLength", "Median_BranchLength", summary_tableNN.B)
summary_tableNN.B = gsub("Terminal_SegLengthIQlogNumNodesranchLengthIQlogNumNodes", "Terminal_SegLengthIQR", summary_tableNN.B)
```

```{r}
summary_tableNN.B 
```

```{r}
# Best fit model summary
cf <- round(coef(m5), 3) 
eqNN.B <- paste0("logNumNodes = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Median_BranchLength",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " BranchLengthIQR")

commentNN.B = "Median_BranchLength, BranchLengthIQR"
rowNN.B = cbind(eqNN.B, commentNN.B)
colnames(rowNN.B) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowNN.B 
```

## Median Branch Length

### All Ocos

```{r}
ocos = all_data[[2]]
ocos = ocos[-1,]
n_branchlen = nrow(ocos)
```

**Testing Covariates** 

Only significant covariates are listed below:

```{r}
m1 = lm(Median_BL_c ~ NumNodes_c, data=ocos) 
m2 = lm(logMedian_BL ~ NumNodes_c, data=ocos)
m3 = lm(Median_BL_c ~ TSegIQR_c, data=ocos)
m4 = lm(logMedian_BL ~ TSegIQR_c, data=ocos)
m5 = lm(Median_BL_c ~ Site, data=ocos) 
m6 = lm(logMedian_BL ~ Site, data=ocos) 
m7 = lm(Median_BL_c ~ Height_c, data=ocos) 
m8 = lm(logMedian_BL ~ Height_c, data=ocos) 

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col) 
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col)
tidy_regression(m6, output_col) 
tidy_regression(m7, output_col)
tidy_regression(m8, output_col)  
```

```{r}
# center variables
ocos$TSegIQR_c = ocos$Terminal_SegIQR - mean(ocos$Terminal_SegIQR, na.rm=TRUE)
ocos$BL_IQR_c = ocos$BranchLength_IQR - mean(ocos$BranchLength_IQR, na.rm=TRUE)
ocos$Median_BL_c = ocos$Median_BranchLength - mean(ocos$Median_BranchLength, na.rm=TRUE)
ocos$NumNodes_c = ocos$Num_Nodes - mean(ocos$Num_Nodes, na.rm=TRUE)
```

**Site, NumNodes_c, Height_c, TSegIQR_c**

```{r}
data<-data.frame(
  R=ocos$logMedian_BL,
  A=ocos$Site,
  B=ocos$Height_c, 
  C=ocos$TSegIQR_c,
  D=ocos$NumNodes_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 4-FF.R")
```

```{r}
anova(m14, m15, test="Chisq") # Adding A does not improve fit
anova(m10, m14, test="Chisq") # Adding B improves fit
anova(m9, m14, test="Chisq") # Adding C improves fit
anova(m8, m14, test="Chisq") # Adding D improves fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m14, ocos)
plot_diagnostic(m10, ocos) 
plot_diagnostic(m9, ocos)
plot_diagnostic(m8, ocos)
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m13) - AIC(m13))
delta2 = abs(AIC(m14) - AIC(m10))
delta3 = abs(AIC(m14) - AIC(m8))
delta4 = abs(AIC(m14) - AIC(m9))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```

```{r}
summary_tableMBL = round(cbind(c(AIC(m14), AIC(m10), AIC(m8), AIC(m9)),
                            c(delta1, delta2, delta3, delta4), 
                            c(me1, me2, me3, me4), 
                            c(weight1, weight2, weight3, weight4)),3)

eq1 = paste(m14$call)[2]
eq2 = paste(m10$call)[2]
eq3 = paste(m8$call)[2]
eq4 = paste(m9$call)[2]

equations = c(eq1, eq2, eq3, eq4)
equations = rename_regformula(equations, "logMedianBL", "Site", "Height", "TerminalSegIQR", "Num_Nodes")

summary_tableMBL = cbind(equations, summary_tableMBL)
colnames(summary_tableMBL) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableMBL = gsub("TerminalSegIQlogMedianBL", "TerminalSegIQR", summary_tableMBL)
```

```{r}
summary_tableMBL
```

```{r}
# Best fit model summary
cf <- round(coef(m14), 3) 
eqMBL <- paste0("logMedian_BranchLength = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " Height",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " TerminalSegIQR",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[4]), " Num_Nodes")

commentMBL = "Height, TerminalSegIQR, Num_Nodes"
rowMBL = cbind(eqMBL, commentMBL)
colnames(rowMBL) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowMBL
```


### Bajada Ocos

```{r}
ocos = all_data[[2]]
ocos_baj = ocos[2:20,]
n_branchlen.b = nrow(ocos_baj)
```

**Testing Covariates** 

Only significant covariates are listed below:

```{r}
m1 = lm(Median_BL_c ~ NumNodes_c, data=ocos_baj) 
m2 = lm(logMedian_BL ~ NumNodes_c, data=ocos_baj)
m3 = lm(Median_BL_c ~ TSegIQR_c, data=ocos_baj)
m4 = lm(logMedian_BL ~ TSegIQR_c, data=ocos_baj)
m5 = lm(Median_BL_c ~ Height_c, data=ocos_baj) 
m6 = lm(logMedian_BL ~ Height_c, data=ocos_baj) 

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col) 
tidy_regression(m4, output_col) 
tidy_regression(m5, output_col)
tidy_regression(m6, output_col)  
```

```{r}
# center variables
ocos_baj$TSegIQR_c = ocos_baj$Terminal_SegIQR - mean(ocos_baj$Terminal_SegIQR, na.rm=TRUE)
ocos_baj$BL_IQR_c = ocos_baj$BranchLength_IQR - mean(ocos_baj$BranchLength_IQR, na.rm=TRUE)
ocos_baj$Median_BL_c = ocos_baj$Median_BranchLength - mean(ocos_baj$Median_BranchLength, na.rm=TRUE)
ocos_baj$NumNodes_c = ocos_baj$Num_Nodes - mean(ocos_baj$Num_Nodes, na.rm=TRUE)
```

**NumNodes_c, Height_c, TSegIQR_c**

```{r}
data<-data.frame(
  R=ocos_baj$logMedian_BL,
  A=ocos_baj$Height_c, 
  B=ocos_baj$TSegIQR_c,
  C=ocos_baj$NumNodes_c) 

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian lm 3-FF.R")
```

```{r}
anova(m7, m12, test="Chisq") # Adding A*C does not improve fit
anova(m6, m7, test="Chisq") # Adding A marginally improves fit
anova(m5, m7, test="Chisq") # Adding B improves fit
anova(m4, m7, test="Chisq") # Adding C improves fit
anova(m3, m6, test="Chisq") # Adding B improves fit
anova(m2, m6, test="Chisq") # Adding C improves fit
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m13) - AIC(m13))
delta2 = abs(AIC(m6) - AIC(m3))
delta3 = abs(AIC(m6) - AIC(m2))
delta4 = abs(AIC(m6) - AIC(m0))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```

```{r}
summary_tableMBL.B = round(cbind(c(AIC(m6), AIC(m3), AIC(m2), AIC(m0)),
                            c(delta1, delta2, delta3, delta4), 
                            c(me1, me2, me3, me4), 
                            c(weight1, weight2, weight3, weight4)),3)

eq1 = paste(m6$call)[2]
eq2 = paste(m3$call)[2]
eq3 = paste(m2$call)[2]
eq4 = paste(m0$call)[2]

equations = c(eq1, eq2, eq3, eq4)
equations = rename_regformula(equations, "logMedianBL", "Height", "TerminalSegIQR", "Num_Nodes")

summary_tableMBL.B = cbind(equations, summary_tableMBL.B)
colnames(summary_tableMBL.B) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableMBL.B = gsub("TerminalSegIQlogMedianBL", "TerminalSegIQR", summary_tableMBL.B)
```

```{r}
summary_tableMBL.B
```

```{r}
# Best fit model summary
cf <- round(coef(m6), 3) 
eqMBL.B <- paste0("logMedian_BranchLength = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " TerminalSegIQR",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " Num_Nodes")

commentMBL.B = "TerminalSegIQR, Num_Nodes"
rowMBL.B = cbind(eqMBL.B, commentMBL.B)
colnames(rowMBL.B) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowMBL.B
```

# Mixed Effect Modeling of Ocotillo Terminal Segments

Analyses below are mixed effect models of Fouquieria splendens terminal segment length for all individuals located on both a bajada and a plain in Organ Pipe National Monument, Arizona. Terminal segment length denotes the length of each of the last five, topmost branches of the ten branches measured per ocotillo. The best fit model is the model with the lowest AIC value. The rest of the models were ordered by their ascending AIC values. No subsets of the data were used in these analyses.

## Re-Reading and Cleaning the Data

```{r}
source("src/cleaning_data.R")
source("src/regression_output.R")
output_col = FALSE

all_data = clean_data("data/General_Oco_Data2.csv", "data/Terminal_5Segs.csv")

ocos = all_data[[2]]
ocos_baj = ocos[1:20,]
segs = all_data[[1]]
seg_baj = segs[1:1000,] 

segs <- segs[!is.na(segs$Length_c),]
```

## Functions

```{r}
### Diagnostic Plot Function

plot_diagnostic = function(m, d) {
  # m:  model generated by lm() or glm()
  # d:  data as a data.frame object
  
  d['fitted_values'] = fitted(m)
  d['fitted_residuals'] = residuals(m)
  
  plot = ggplot(data = d) + geom_point(aes(x = fitted_values, y = fitted_residuals)) +
  geom_hline(yintercept = 0) +
  labs(title = "Plot of Fitted Residuals against Fitted Values",
       x = "Fitted Values", y = "Fitted Residuals") 
  
  return(plot)
}
```

```{r}
## Renaming Regression Formulas Function

rename_regformulaME = function (eqs, response_var, predA, predB, predC, randX, randY) {
  # eqs:              list of linear regression formals as characters
  # response_var:     response variable as a character
  # predA:            predictor variable A as a character
  # predB:            predictor variable B as a character
  # predC:            predictor variable C as a character
  # randX:            random variable X as a character
  # randY:            random variable Y as a character
  for (i in 1:length(eqs)) {
  if (grepl(" A", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("A", predA, eqs[i])
  }
  if (grepl(" B", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("B", predB, eqs[i])
  }
  if (grepl(" C", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("C", predC, eqs[i])
  }
  if (grepl("X", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("X", randX, eqs[i])
  }
    if (grepl("Y", eqs[i], fixed = TRUE)) {
    eqs[i] =  gsub("Y", randY, eqs[i])
  }
  if (grepl( "R", eqs[i], fixed = TRUE)) {
    eqs[i] = gsub("R", response_var, eqs[i])
  }
  }
  return(eqs)
}
```


**Addressing and Removing the Outlier**

```{r}
# Cleveland Dotplot & Boxplot
par(mfrow=c(1,2))
x = segs$Length
y = seq(1, length(x),)
plot(x,y, ylab="Order of the data", xlab="Terminal Segment Length")
boxplot(segs$Length)

segs = segs[segs$Tree != 1,] # remove Plant 1 outlier 

x = segs$Length
y = seq(1, length(x),)
plot(x,y, ylab="Order of the data", xlab="Terminal Segment Length")
boxplot(segs$Length)
```

```{r}
segs <- segs[complete.cases(segs$Length),]
n_segs = nrow(segs)
```

```{r}
# re-centering variables used below
segs$BL_IQR_c = segs$BL_IQR - mean(segs$BL_IQR, na.rm=TRUE)
segs$NumNodes_c = segs$NumNodes - mean(segs$NumNodes, na.rm=TRUE)
```

**Testing Covariates**

Dropped branch_num as a random factor to better help the model fit the data.

Only significant covariates are listed below:

```{r echo=FALSE}
m1 = lmer(Length_c ~ T1m_NumCacti + (1|Tree) + (1|seg_num), data=segs) 
m2 = lmer(Length_c ~ R1m_shrub2cactus + (1|Tree) + (1|seg_num), data=segs)
m3 = lmer(Length_c ~ NumNodes_c + (1|Tree) + (1|seg_num), data=segs)
m4 = lmer(Length_c ~ BL_IQR_c + (1|Tree) + (1|seg_num), data=segs)

tidy_regression(m1, output_col) # marginal
tidy_regression(m2, output_col) # marginal
tidy_regression(m3, output_col) 
tidy_regression(m4, output_col)
```

**T1m_NumCacti, NumNodes_c, BL_IQR_c**

```{r}
data<-data.frame(
  R=segs$Length_c,
  A=segs$T1m_NumCacti, 
  B=segs$NumNodes_c, 
  C=segs$BL_IQR_c,
  X=segs$Tree,
  Y=segs$seg_num)

# Fit the models to the same number of observations by filtering out NA values:
data <- data[complete.cases(data),]
n_segs = nrow(data)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian glmer 2-RF + 3-FF REMLF.R")
```

```{r}
anova(m7, m11, test="Chisq") # Adding A*B does improve fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m5, m7, test="Chisq") # Adding B does improve fit
anova(m4, m7, test="Chisq") # Adding C does not improve fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m11, segs)
plot_diagnostic(m7, segs)
plot_diagnostic(m6, segs)
plot_diagnostic(m5, segs)
plot_diagnostic(m4, segs)
```

**Model Comparisons**

**R1m_shrub2cactus, NumNodes_c, BL_IQR_c**

```{r}
data
```

```{r}
data<-data.frame(
  R=segs$Length_c,
  A=segs$R1m_shrub2cactus, 
  B=segs$NumNodes_c, 
  C=segs$BL_IQR_c,
  X=segs$Tree,
  Y=segs$seg_num)

# Fit the models to the same number of observations by filtering out NA values:
data <- data[complete.cases(data),]
n_segs = nrow(data)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian glmer 2-RF + 3-FF REMLF.R")
```

```{r}
anova(m11, m14, test="Chisq") # Adding A*C does not improve fit
anova(m7, m11, test="Chisq") # Adding A*B does improve fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m5, m7, test="Chisq") # Adding B does improve fit
anova(m4, m7, test="Chisq") # Adding C does improve fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m11, data)
plot_diagnostic(m7, data)
plot_diagnostic(m6, data)
plot_diagnostic(m4, data)
```
**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m4) - AIC(m4))
delta2 = abs(AIC(m11) - AIC(m6))
delta3 = abs(AIC(m11) - AIC(m7))
delta4 = abs(AIC(m11) - AIC(m4))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```


```{r}
summary_tableS = round(cbind(c(AIC(m11), AIC(m6), AIC(m7), AIC(m4)),
                            c(delta1, delta2, delta3, delta4), 
                            c(me1, me2, me3, me4), 
                            c(weight1, weight2, weight3, weight4)),3)

eq1 = c(paste(formula(m11))[2], paste(formula(m11))[1], paste(formula(m11))[3]) %>%
 paste(collapse=' ')
eq2 = c(paste(formula(m6))[2], paste(formula(m6))[1], paste(formula(m6))[3]) %>%
 paste(collapse=' ')
eq3 = c(paste(formula(m7))[2], paste(formula(m7))[1], paste(formula(m7))[3]) %>%
 paste(collapse=' ')
eq4 = c(paste(formula(m4))[2], paste(formula(m4))[1], paste(formula(m4))[3]) %>%
 paste(collapse=' ')

equations = c(eq1, eq2, eq3, eq4)
equations = rename_regformulaME(equations, "Length_c", "1m_shrub2cactus", "Number_Nodes", "BranchLengthIQR", "tree", "seg_num")

summary_tableS = cbind(equations, summary_tableS)
colnames(summary_tableS) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableS = gsub("BranchLengthIQLength_c", "BranchLengthIQR", summary_tableS)
```

```{r}
summary_tableS
```

```{r}
# Best fit model summary
cf <- round(summary(m11)$coefficient, 2)
eqS <- paste0("Length = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " 1m_shrub2cactus",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " Number_Nodes", 
             ifelse(sign(cf[4])==1, " + ", " - "), abs(cf[4]), " BranchLengthIQR",
             ifelse(sign(cf[5])==1, " + ", " - "), abs(cf[5]), " 1m_shrub2cactus*Number_Nodes",
             " + (1 | tree) + (1 | seg_num)")

commentS = "Number_Nodes, BranchLengthIQR, 1m_shrub2cactus*Number_Nodes"
rowS = cbind(eqS, commentS)
colnames(rowS) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowS
```


## Bajada Ocos

```{r}
# remove NAs
seg_baj = seg_baj[!is.na(seg_baj$Length),]
# remove Plant 1 outlier
seg_baj = seg_baj[seg_baj$Tree != 1,] 

n_segs.b = nrow(seg_baj)

# re-centering variables used below
seg_baj$BL_IQR_c = seg_baj$BL_IQR - mean(seg_baj$BL_IQR, na.rm=TRUE)
seg_baj$NumNodes_c = seg_baj$NumNodes - mean(seg_baj$NumNodes, na.rm=TRUE)
```

**Testing Covariates**

Dropped branch_num as a random factor to better help the model fit the data.

Only significant covariates are listed below (most are marginal in this case):

```{r echo=FALSE}
m1 = lmer(Length_c ~ T1m_NumCacti + (1|Tree) + (1|seg_num), data=seg_baj) 
m2 = lmer(Length_c ~ R1m_shrub2cactus + (1|Tree) + (1|seg_num), data=seg_baj)
m3 = lmer(Length_c ~ BL_IQR_c + (1|Tree) + (1|seg_num), data=seg_baj)
m4 = lmer(Length_c ~ NumNodes_c + (1|Tree) + (1|seg_num), data=seg_baj)

tidy_regression(m1, output_col) 
tidy_regression(m2, output_col)
tidy_regression(m3, output_col)
tidy_regression(m4, output_col)
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
temp_seg_baj = seg_baj[complete.cases(seg_baj$R1m_shrub2cactus),]

plot_diagnostic(m1, seg_baj)
plot_diagnostic(m2, temp_seg_baj)
plot_diagnostic(m3, seg_baj)
plot_diagnostic(m4, seg_baj)
```

**T1m_NumCacti, BL_IQR_c, NumNodes_c**

```{r}
data<-data.frame(
  R=seg_baj$Length_c,
  A=seg_baj$T1m_NumCacti, 
  B=seg_baj$BL_IQR_c, 
  C=seg_baj$NumNodes_c,
  X=seg_baj$Tree,
  Y=seg_baj$seg_num)

# Fit the models to the same number of observations by filtering out NA values:
data <- data[complete.cases(data),]
n_segs.b = nrow(data)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian glmer 2-RF + 3-FF REMLF.R")
```
```{r}
anova(m5, m7, test="Chisq") # Adding B marginally improves fit
anova(m6, m7, test="Chisq") # Adding A marginally improves fit
anova(m4, m7, test="Chisq") # Adding C improves fit
anova(m2, m6, test="Chisq") # Adding C improves fit
anova(m3, m6, test="Chisq") # Adding B marginally improves fit
```

**Plot diagnostics**

All passed. Residuals are independent.

```{r}
plot_diagnostic(m7, data)
plot_diagnostic(m6, data)
plot_diagnostic(m2, data)
plot_diagnostic(m3, data)
```

**R1m_shrub2cactus, BL_IQR_c, NumNodes_c**

```{r}
data<-data.frame(
  R=seg_baj$Length_c,
  A=seg_baj$R1m_shrub2cactus, 
  B=seg_baj$BL_IQR_c, 
  C=seg_baj$NumNodes_c,
  X=seg_baj$Tree,
  Y=seg_baj$seg_num)

# Fit the models to the same number of observations by filtering out NA values:
data <- data[complete.cases(data),]
n_segs.b = nrow(data)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian glmer 2-RF + 3-FF REMLF.R")
```
```{r}
anova(m6, m7, test="Chisq") # Adding A marginally improves fit
anova(m5, m7, test="Chisq") # Adding B improves fit
anova(m4, m7, test="Chisq") # Adding A improves fit
anova(m3, m6, test="Chisq") # Adding B improves fit
anova(m2, m6, test="Chisq") # Adding C improves fit
```

**Calculate likelihood and weights**

```{r}
# Calculate relative likelihood of each model which is exp( -0.5 * deltaAIC)

delta1 = 0 # abs(AIC(m4) - AIC(m4))
delta2 = abs(AIC(m6) - AIC(m2))
delta3 = abs(AIC(m6) - AIC(m3))
delta4 = abs(AIC(m6) - AIC(m0))

me1 <- exp( -0.5 * delta1)
me2 <- exp( -0.5 * delta2)
me3 <- exp( -0.5 * delta3)
me4 <- exp( -0.5 * delta4)

# Calculate the Akaike weight for a model which is this value divided by the sum of these values across all models.

sum <- sum(c(me1, me2, me3, me4))

weight1 = me1 / (sum) 
weight2 = me2 / (sum)
weight3 = me3 / (sum)
weight4 = me4 / (sum)
```
  
```{r}
summary_tableS.B = round(cbind(c(AIC(m6), AIC(m2), AIC(m3), AIC(m0)),
                            c(delta1, delta2, delta3, delta4), 
                            c(me1, me2, me3, me4), 
                            c(weight1, weight2, weight3, weight4)),3)

eq1 = c(paste(formula(m7))[2], paste(formula(m7))[1], paste(formula(m7))[3]) %>%
 paste(collapse=' ')
eq1 = c(paste(formula(m6))[2], paste(formula(m6))[1], paste(formula(m6))[3]) %>%
 paste(collapse=' ')
eq2 = c(paste(formula(m2))[2], paste(formula(m2))[1], paste(formula(m2))[3]) %>%
 paste(collapse=' ')
eq3 = c(paste(formula(m3))[2], paste(formula(m3))[1], paste(formula(m3))[3]) %>%
 paste(collapse=' ')
eq4 = c(paste(formula(m0))[2], paste(formula(m0))[1], paste(formula(m0))[3]) %>%
 paste(collapse=' ')

equations = c(eq1, eq2, eq3, eq4)
equations = rename_regformulaME(equations, "Length", "1m_shrub2cactus", "BranchLengthIQR", "Number_Nodes", "tree", "seg_num")

summary_tableS.B = cbind(equations, summary_tableS.B)
colnames(summary_tableS) = c("Equation", "AIC","dAIC", "Likelihood","Weight")
```

```{r}
summary_tableS.B = gsub("BranchLengthIQLength", "BranchLengthIQR", summary_tableS.B)
```

```{r}
summary_tableS.B
```

```{r}
# Best fit model summary
cf <- round(summary(m7)$coefficient, 2)
eqS.B <- paste0("Length = ", cf[1],
             ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " BranchLengthIQR",
             ifelse(sign(cf[3])==1, " + ", " - "), abs(cf[3]), " Number_Nodes",
             " + (1 | Tree) + (1 | seg_num)")

commentS.B = "BranchLengthIQR and Number_Nodes"  
rowS.B = cbind(eqS.B, commentS.B)
colnames(rowS.B) = c("Best Fit Model", "Significant Vars (p < 0.05)")
rowS.B
```


## Summary Tables to CSV

```{r}
dataset = c("all", "bajada", "all", "bajada", "all", "bajada", "all", "bajada",
            "all", "bajada", "all", "bajada")
best_fit_table = rbind(rowH, rowH.B,
                       rowS, rowS.B,
                       rowNN, rowNN.B,
                       rowMBL, rowMBL.B,
                       rowC, rowC.B,
                       rowNB, rowNB.B
                       )
num_segs = 26 # writing down number of ocotillos 
num_segs.b = 19  # writing down number of ocotillos 
sample_sizes = c(n_height, n_height.b,
                 num_segs, num_segs.b,
                 n_nodes, n_nodes.b,
                 n_branchlen, n_branchlen.b,
                 n_circ, n_circ.b,
                 n_branch, n_branch.b)

best_fit_summary = cbind(dataset, sample_sizes, best_fit_table)
colnames(best_fit_summary) = c("Dataset", "Sample Size", "Best Fit Model", "Significant Vars (p < 0.05)")

write.csv(best_fit_summary,'best_fits_morph.csv', row.names=FALSE)
```


```{r}
setH = c("all", "all", "all", "all",
             "bajada", "bajada", "bajada")
setS = c("all", "all", "all", "all",
             "bajada", "bajada", "bajada", "bajada")
setN = c("all", "all", "all", "all",
             "bajada", "bajada", "bajada", "bajada")
setMBL = c("all", "all", "all", "all",
             "bajada", "bajada", "bajada", "bajada")
setC = c("all", "all", "all",
             "bajada", "bajada")
setB = c("all", "all", "all", "all",
             "bajada", "bajada", "bajada", "bajada", "bajada")

datasets = c(setH, setS, setN, setMBL, setC, setB)
```

```{r}
full_table = rbind(summary_tableH, summary_tableH.B,
                   summary_tableS, summary_tableS.B,
                   summary_tableNN, summary_tableNN.B,
                   summary_tableMBL, summary_tableMBL.B,
                   summary_tableC, summary_tableC.B,
                   summary_tableB, summary_tableB.B
                  )

full_table = cbind(datasets, full_table)
colnames(full_table) = c("Dataset", "Equation", "AIC","dAIC", "Likelihood","Weight")
full_table

write.csv(full_table,'morph_regressions.csv', row.names=FALSE)
```

