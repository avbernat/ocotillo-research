---
title: 'Appendix'
subtitle: "for  \n'Examining Fouquieria splendens in an environmental and ecological context: Effect of topography and interspecific neighbors on ocotillo morphology and distribution';"
author: "Anastasia Bernat, Acacia Tsz So Tang, Allegra Steenson, Eric Larsen, Emma Greig"

geometry: margin=2cm
output:
  pdf_document:
    includes: null
    toc: yes
    toc_depth: 3
    number_sections: true
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
line-height: 1.5
fontsize: 11pt
classoption: a4paper
language: en
---

```{r setup, include=FALSE}
rm(list=ls())

options(max.print = 10000) 

dir = "/Users/anastasiabernat/Desktop/git_repositories/ocotillo-research/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```

\newpage

# Details of the Analyses

This document was generated by R Markdown on `r format(Sys.time(), '%Y-%m-%d')` using `r version[['version.string']]`. The document provides the step-by-step analytical methods used in the manuscript by Anastasia Bernat (AVB), Acacia Tsz So Tang (ATST), Allegra Steenson (AS), Eric Larsen (EL), and Emma Greig (EG). Draft scripts were written by AVB and ATST between 2019-06-01 and 2021-01-01 until being distilled and complied by AVB at the University of Chicago into this comprehensive script. All draft scripts can be viewed in the GitHub repository, ocotillo-research (https://github.com/avbernat/ocotillo-research).

All code and output from the statistical analyses are shown. Code for data cleaning and the generation of plots is not displayed, but can be viewed in the **appendix.Rmd** file and its accompanying sourced scripts. To repeat analyses and the generation of plots, all data files and sourced scripts should follow the directory structure presented in the ocotillo-research repository.

## Description of the Data

Ocotillos, *Fouquieria splendens*, were measured in Summer 2019 in the Sonoran Desert at Organ Pipe Cactus National Monument

## Abbreviations Used in the Data and Code

## Data Transformations 

* `_b` - a column name that ends in `_b` is a column that has been recodified into binary data (0's and 1's). Example columns:
* `_c` - a column name that ends in `_c` is a column that has been centered. Example columns:
* `_s` - a column name that ends in `_s` is a column that has been standardized. Example columns:
* `log` - a column name that starts with `log` is a column that has been log transformed. Example columns:
* `_baj` - a dataset that ends in `_baj` is a dataset that only contains ocotillo measurements from ocotillos across a bajada. Example datasets: ocos_baj, segs_baj

## Read in Libraries 

```{r message=FALSE}
library(dplyr)
library(outliers) # dixon.test
require(FactoMineR) # PCA function
library(factoextra) # get_eigenvalue function
library(corrplot) # cor.mtest
# library(ggplot2)
# library(olsrr)
# library(lme4)
# 
# library(tidyverse)
# library(ggpubr)
# library(rstatix)
```


## Read Source Scripts 

```{r}
source("src/cleaning_data.R")
source("src/regression_output.R")
source("src/diagnostics.R")
source("src/pretty_reg.R")
source("src/pca.R")
```


## Read the Data 

```{r}
ocotillo_data = read.csv("data/General_Oco_Data3.csv", 
                            fileEncoding="UTF-8-BOM",  stringsAsFactors=TRUE)
branch_data = read.csv("data/branch_lengths_long.csv")
segment_data = read.csv("data/Terminal_5Segs.csv")

branches = branch_data  %>%
            group_by(Tree) %>%
            summarize(Mean_BranchLength = mean(BranchLength, na.rm=TRUE),
                      Median_BranchLength = median(BranchLength, na.rm=TRUE),
                      Max_BranchLength = max(BranchLength, na.rm=TRUE),
                      Min_BranchLength = min(BranchLength, na.rm=TRUE),
                      BranchLength_IQR = IQR(BranchLength, na.rm=TRUE))
segments = segment_data %>%
            group_by(Tree) %>%
            summarize(Mean_Terminal_SegmentLength = mean(Length, na.rm=TRUE),
                      Median_Terminal_SegmentLength = median(Length, na.rm=TRUE),
                      Max_Terminal_SegmentLength = max(Length, na.rm=TRUE),
                      Min_Terminal_SegmentLength = min(Length, na.rm=TRUE),
                      IQR_Terminal_SegmentLength = IQR(Length, na.rm=TRUE))


ocotillo_data$Median_BranchLength = branches$Median_BranchLength # other typos
ocotillo_data$BranchLength_IQR = branches$BranchLength_IQR # other typos
ocotillo_data$Median_TerminalSeg = segments$Median_Terminal_SegmentLength
ocotillo_data$Terminal_SegIQR = segments$IQR_Terminal_SegmentLength

ocos = clean_ocos_data(ocotillo_data)               # all ocotillos
ocos_baj = ocos[1:20,]                              # only ocotillos across the bajada
segs = clean_segs_data(segment_data, ocotillo_data) # all ocotillos
segs_baj = segs[1:1000,]                            # only ocotillos across the bajada
```


## Normality

All measurements followed log-normal distributions except for circumference, median branch length, number of nodes, and distance to the nearest arroyo, which were normally distributed. Ocotillo data were log-transformed before analyses to meet assumptions of normality, linear regressions, and homogeneity for parametric analyses.

## Outliers

Terminal segment length IQR has an outlier - Ocotillo 1 (see graphs.Rmd). In turn, the outlier was removed and logHeight is predicted with a smaller dataset containing all ocotillos except Ocotillo 1.

```{r}
dixon.test(ocos$Terminal_SegIQR)
```
```{r}
ocos_data = ocotillo_data[ocotillo_data$Tree != 1,]
segs_data = segment_data[segment_data$Tree != 1,]

# rerun data cleaning to generate newly transformed columns
ocos = clean_ocos_data(ocos_data)               
ocos_baj = ocos[1:20,]                            
segs = clean_segs_data(segs_data, ocos_data)
segs_baj = segs[1:1000,]                        
```

# Ocotillo Morphology 

Analyses below are multiple variate models of Fouquieria splendens morphology for ocotillos located on both a bajada and a plain in Organ Pipe National Monument, Arizona. All models were grouped by their response variable and ordered by their ascending AIC values. Dataset "ocos" indicates all individuals measured on the bajada and plain while "ocos_baj" indicates only the individuals measured on the bajada. Ocotillos located on the bajada were encoded with site = 0 while ocotillos on the plain were encoded with site = 1. Interspecific neighbor group is split between two types – shrub and cactus – where cactus = 0 and shrub = 1. 

## Principal Component Analysis

```{r}
growthForm <- read.csv("data/growthForm2.csv", row.names = 1)
```

### Without IQR Vars:

```{r}
d = ocos[, c("Height", "Circumference", 
             "Number_Branches", "Median_BranchLength", 
             "Num_Nodes", "Median_TerminalSeg")]
abbreviations = c("Height", "Circ", "NB", "M TSL", "M BL", "Nodes")
PCA_graphs(d, "(a) ", abbreviations)
```

```{r fig.height=2.5, fig.width=2.6}
# Plant 1 Removed | Without IQR Vars

d = growthForm[-1, c(-5,-6)]
abbreviations = c("Height", "Circ", "NB", "M TSL", "M BL", "Nodes")
PCA_graphs(d, "(a) ", abbreviations)
```

### With IQR Vars:

```{r fig.height=2.5, fig.width=2.6}
# Plant 1 Removed 

d = ocos[, c("Height", "Circumference", 
             "Number_Branches", "Median_BranchLength", 
             "Num_Nodes", "Median_TerminalSeg", 
             "BranchLength_IQR",
             "Terminal_SegIQR")]
abbreviations = c("Height", "Circ", "NB", "M TSL", "TSL IQR", "BL IQR", "M BL", "Nodes")
PCA_graphs(d, "(b)", abbreviations)
```

```{r fig.height=2.5, fig.width=2.6}
# Plant 1 Removed 

d = growthForm[-1, ]
PCA_graphs(d, "(b)")

colnames(d) = c("Height", "Circ", "NB", "M TSL", "TSL IQR", "BL IQR", "M BL", "Nodes")
D = cor(d)
test <- cor.mtest(d)$p
corrplot.mixed(D,lower.col = "black", number.cex = .7, p.mat=test, sig.level=0.05)
corrplot.mixed(D,lower.col = "black", number.cex = .7)
```

This PCA suggests that there is a lot of variation around range, so much so that it apparently drives the PCA when you add it in.


## Multiple Variate Modeling

### Testing Covariates 

Only significant covariates are listed below:

```{r}
output_color = FALSE
```

```{r echo=FALSE}
m1 = lm(logHeight ~ Elevation_c, data=ocos)
m2 = lm(Height_c ~ Site, data=ocos)
m3 = lm(logHeight ~ Site, data=ocos)
m4 = lm(Height ~ Median_BL_c, data=ocos)
m5 = lm(logHeight ~ Median_BL_c, data=ocos)
m6 = lm(Height ~ NumNodes_c, data=ocos)
m7 = lm(logHeight ~ NumNodes_c, data=ocos)

tidy_regression(m1, output_color) 
tidy_regression(m2, output_color)
tidy_regression(m3, output_color)
tidy_regression(m4, output_color) 
tidy_regression(m5, output_color)
tidy_regression(m6, output_color)
tidy_regression(m7, output_color)
```


### Branch Length and Elevation Affect Number of Nodes

### Height, Number of Nodes, and Terminal Segment Length IQR Affect Median Branch Length

### Number of Nodes, Branch Length IQR, and Number of Cacti Affect Terminal Segment Lengths

### Number of Branches Affects Circumference

# Ocotillo Neighbors and Site Geography

## Multiple Variate Modeling

### Circumference, Major Interspecific Group, and Arroyo Distance Affect Number of Branches

### Elevation and Ocotillo Size Relates to Nearest Ocotillo Distance

### Arroyo Distance Relates to Interspecific Distance





