---
title: "Graphs"
author: "Anastasia Bernat"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())

library(rethinking)
library(dplyr)
library(rstatix)
library(ggplot2)
library(ggpubr)

dir = "/Users/anastasiabernat/Desktop/git_repositories/ocotillo-research/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```

## Reading and Cleaning the Data

```{r}
source("src/cleaning_data.R")
source("src/regression_output.R")
output_col = FALSE

all_data = clean_data("data/General_Oco_Data.csv", "data/Terminal_5Segs.csv")

ocos = all_data[[2]]
ocos_baj = ocos[ocos$Plant[1:20],]

seg_baj = all_data[[1]][[1]]
segs = all_data[[1]][[2]]

segs <- segs[!is.na(segs$Length_c),]
```


## Shared Plotting Parameters

```{r}
c1 = 1.2 * 1.2
c2 = 1.3 * 1.2
c3 = 1.5 * 1.2
c4 = 1.1 * 1.2
```

```{r}
ocos %>%
  select(Plant, logHeight, Terminal_SegIQR, TSegIQR_c, Height)
outlier = ocos %>%
  filter(Plant !=1)
```
```{r}
d = outlier
x=d[,"TSegIQR_c"]
y=d[,"logHeight"] 

m <- lm(logHeight ~ TSegIQR_c, data=outlier)
x.seq = seq(min(x) - sd(x), max(x) + sd(x), length.out=100)
m <- lm(y ~ x, data=outlier)
prd <- data.frame(x=x.seq) # newdata
err <- predict(m, newdata = prd, se.fit = TRUE)
prd$lci <- err$fit - 1.96 * err$se.fit
prd$fit <- err$fit
prd$uci <- err$fit + 1.96 * err$se.fit
mu_ci <- t(matrix(c(prd$lci,prd$uci), ncol=2))

colfunc <- colorRampPalette(c("red", "orange"))
plot(outlier$logHeight ~ outlier$TSegIQR_c, 
     col=colfunc(2)[as.factor(outlier$Site)], 
     pch = c(17:16)[as.factor(outlier$Site)],
     xlab = "Terminal Segment Length IQR (cm)",
     ylab= "Log(Height) (m)", 
     cex=c2,
     cex.lab=c3,
     cex.axis=c2,
     bty="n") 
legend(7,1,
       legend = c("Bajada", "Plain"),
       col= c(colfunc(2)[1], colfunc(2)[2]),
       pch = c(17:16),
       cex=c4,
       title="Site Type")
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval <- paste0("p = ", round(summary(m)$coefficients[8],3))
text(1, 1.5, pval, cex=c1)
title("(b)", adj = 0.05, line = 0, cex.main=c3)

summary(lm(logHeight ~ TSegIQR_c + Site, data=outlier))
```

```{r}
growthForm <- read.csv("data/growthForm.csv", row.names = 1)
outlier = growthForm[2:27,]
```

```{r}
library(outliers)
grubbs.test(growthForm$Terminal.segment.IQR, type = 10, opposite = FALSE, two.sided = FALSE)
growthForm$Terminal.segment.IQR
```

**Investigating Variables**

```{r}
GFpca <- PCA(growthForm, scale.unit = TRUE, graph = TRUE, ncp = 10)
GFpca <- PCA(outlier, scale.unit = TRUE, graph = TRUE, ncp = 10)
eig.val <- get_eigenvalue(GFpca)
eig.val
fviz_eig(GFpca, addlabels = TRUE, ylim = c(0, 50))
```


```{r}
variables <- get_pca_var(GFpca)

corrplot(variables$cos2, is.corr=FALSE)
corrplot(variables$contrib, is.corr=FALSE)

GFdim <- dimdesc(GFpca, axes = c(1,2), proba = 0.05)
GFdim$Dim.1
GFdim$Dim.2
```

**Plot by Group**

```{r}
Groupings <- read_csv("data/Groupings.csv")
Groupings = Groupings[2:27,]
outlier$Inter_Plant_Group <- Groupings$Inter_Plant_Group
outlier$Site <- Groupings$Site

fviz_pca_ind(GFpca,
             geom.ind = "text",
             col.ind = outlier$Inter_Plant_Group,
             legend.title = "Interspecific Group",
             addEllipses = TRUE
)

fviz_pca_ind(GFpca,
             geom.ind = "text",
             col.ind = outlier$Site,
             legend.title = "Site Type",
              addEllipses = TRUE
)
```

## Height

```{r fig.width=2.1, fig.height=5.18}

par(mfrow=c(3,1))

###### Plot A

d = ocos
x=d[,"Elevation_c"]
y=d[,"logHeight"] 

m <- lm(logHeight ~ Elevation_c, data=ocos)
x.seq = seq(min(x) - sd(x), max(x) + sd(x), length.out=100)
m <- lm(y ~ x, data=ocos)
prd <- data.frame(x=x.seq) 
err <- predict(m, newdata = prd, se.fit = TRUE)
prd$lci <- err$fit - 1.96 * err$se.fit
prd$fit <- err$fit
prd$uci <- err$fit + 1.96 * err$se.fit
mu_ci <- t(matrix(c(prd$lci,prd$uci), ncol=2))

par(mar = c(5, 5, 2, 0)) 
colfunc <- colorRampPalette(c("red", "orange"))
plot(ocos$logHeight ~ ocos$Elevation_c, 
     col=colfunc(2)[as.factor(ocos$Site)], 
     pch = c(17:16)[as.factor(ocos$Site)],
     xlab = "Elevation (m)",
     ylab= "Log(Height) (m)", 
     cex=c2,
     cex.lab=c3,
     cex.axis=c2,
     bty="n",
     xlim=c(-50, 40)
     ) 
legend(3,1.58,
       legend = c("Bajada", "Plain"),
       col= c(colfunc(2)[1], colfunc(2)[2]),
       pch = c(17:16),
       cex=c4,
       title="Site Type")
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval <- paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(-16, 1.4, pval, cex=c1)
title("(a)", adj = 0.05, line = 0, cex.main=c3)

###### Plot B

d = ocos
x=d[,"TSegIQR_c"]
y=d[,"logHeight"] 

m <- lm(logHeight ~ TSegIQR_c, data=ocos)
x.seq = seq(min(x) - sd(x), max(x) + sd(x), length.out=100)
m <- lm(y ~ x, data=ocos)
prd <- data.frame(x=x.seq) # newdata
err <- predict(m, newdata = prd, se.fit = TRUE)
prd$lci <- err$fit - 1.96 * err$se.fit
prd$fit <- err$fit
prd$uci <- err$fit + 1.96 * err$se.fit
mu_ci <- t(matrix(c(prd$lci,prd$uci), ncol=2))

colfunc <- colorRampPalette(c("red", "orange"))
plot(ocos$logHeight ~ ocos$TSegIQR_c, 
     col=colfunc(2)[as.factor(ocos$Site)], 
     pch = c(17:16)[as.factor(ocos$Site)],
     xlab = "Terminal Segment Length IQR (cm)",
     ylab= "Log(Height) (m)", 
     cex=c2,
     cex.lab=c3,
     cex.axis=c2,
     bty="n") 
legend(7,1,
       legend = c("Bajada", "Plain"),
       col= c(colfunc(2)[1], colfunc(2)[2]),
       pch = c(17:16),
       cex=c4,
       title="Site Type")
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval <- paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(7, 1.1, pval, cex=c1)
title("(b)", adj = 0.05, line = 0, cex.main=c3)

###### Plot C

par(bty = 'n')
boxplot(logHeight~Site,
        data=ocos,
        xlab = "Site",
        ylab= "Log(Height) (m)",
        col=c(col.alpha( "red" , alpha = 0.4 ), 
              col.alpha( "orange" , alpha = 0.4)),
        border="gray30",
        names=c("Bajada", "Plain"),
     cex=c2,
     cex.lab=c3,
     cex.axis=c2
)
title("(c)", adj = 0.05, line = 0, cex.main=c3)
```

```{r fig.width=3.0, fig.height=2.9}

###### Plot B Pooled by Site

dB <- ocos %>%
  filter(Site==0)
dP <- ocos %>%
  filter(Site==1)

xB=dB[,"TSegIQR_c"]
yB=dB[,"logHeight"] 
xP=dP[,"TSegIQR_c"]
yP=dP[,"logHeight"] 

mB <- lm(yB ~ xB, data=dB)
mP <- lm(yP ~ xP, data=dP)
xB.seq = seq(min(xB) - sd(xB), max(xB) + sd(xB)*2, length.out=100)
xP.seq = seq(min(xP) - 2*sd(xP), max(xP) + sd(xP), length.out=100)

prdB <- data.frame(xB=xB.seq) # newdata
prdP <- data.frame(xP=xP.seq) # newdata

errB <- predict(mB, newdata = prdB, se.fit = TRUE)
errP <- predict(mP, newdata = prdP, se.fit = TRUE)

prdB$lciB <- errB$fit - 1.96 * errB$se.fit
prdP$lciP <- errP$fit - 1.96 * errP$se.fit

prdB$fit <- errB$fit
prdP$fit <- errP$fit

prdB$uci <- errB$fit + 1.96 * errB$se.fit
prdP$uci <- errP$fit + 1.96 * errP$se.fit

mu_ciB <- t(matrix(c(prdB$lci,prdB$uci), ncol=2))
mu_ciP <- t(matrix(c(prdP$lci,prdP$uci), ncol=2))

colfunc <- colorRampPalette(c("red", "orange"))
plot(ocos$logHeight ~ ocos$TSegIQR_c, 
     col=colfunc(2)[as.factor(ocos$Site)], 
     pch = c(17:16)[as.factor(ocos$Site)],
     xlab = "Terminal Segment Length IQR (cm)",
     ylab= "Log(Height)", 
     cex=c2,
     cex.lab=c3,
     cex.axis=c2,
     bty="n"
     ) 
legend(7, 1,
       legend = c("Bajada", "Plain"),
       col= c(colfunc(2)[1],colfunc(2)[2] ),
       #bty="n",
       pch = c(17:16),
       cex=c1,
       title="Site Type"
       )
abline(mB, lty=2, col="red")
abline(mP, lty=2, col="darkorange")
shade(mu_ciB, lim = prdB$xB, col=col.alpha("darkred"))
shade(mu_ciP, lim = prdP$xP, col=col.alpha("orange"))
pvalB <- paste0("p = ", round(summary(mB)$coefficients[8],3), "*")
pvalP <- paste0("p = ", round(summary(mP)$coefficients[8],3))
text(5, 1, pvalB, cex=c1, col="red")
text(-3, 1.4, pvalP, cex=c1, col="darkorange")
title("(b)", adj = 0.05, line = 0, cex.main=c3)
summary(mB)
summary(mP)
```


## Circumference and Number of Branches

```{r fig.width=2.1, fig.height=5.18}

par(mfrow=c(3,1))
par(mar = c(4, 5, 2, 0)) 

###### Plot A

d = ocos
x=d[,"Circumference"]
y=d[,"logNB"] 

x.seq = seq(min(x) - sd(x), max(x) + sd(x), length.out=100)
m <- lm(y ~ x, data=ocos)
prd <- data.frame(x=x.seq) # newdata
err <- predict(m, newdata = prd, se.fit = TRUE)
prd$lci <- err$fit - 1.96 * err$se.fit
prd$fit <- err$fit
prd$uci <- err$fit + 1.96 * err$se.fit
mu_ci <- t(matrix(c(prd$lci,prd$uci), ncol=2))

colfunc <- colorRampPalette(c("darkblue", "indianred1"))
plot(ocos$logNB ~ ocos$Circumference, 
     col=colfunc(2)[as.factor(ocos$Inter_Plant_Group)], 
     pch = c(17:16)[as.factor(ocos$Inter_Plant_Group)],
     xlab = "Circumference (m)",
     ylab= "Log(Number of Branches)", 
     cex=c2,
     cex.lab=c3,
     cex.axis=c2,
     bty="n",
     ylim=c(2,4.1),
     xlim=c(3,9)
     ) 
legend(7.5, 2.65,
       legend = c("Cactus", "Shrub"),
       col= c(colfunc(2)[1],colfunc(2)[2] ),
       #bty="n",
       pch = c(17:16),
       cex=c1
       )
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval <- paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(7, 2.95, pval, cex=c1)
title("(b)", adj = 0.05, line = 0, cex.main=c3)

###### Plot B

d = ocos
x=d[,"Arroyo_Dis"]
y=d[,"logNB"] 

x.seq = seq(min(x) - sd(x), max(x) + sd(x), length.out=100)
m <- lm(y ~ x, data=ocos)
prd <- data.frame(x=x.seq) # newdata
err <- predict(m, newdata = prd, se.fit = TRUE)
prd$lci <- err$fit - 1.96 * err$se.fit
prd$fit <- err$fit
prd$uci <- err$fit + 1.96 * err$se.fit
mu_ci <- t(matrix(c(prd$lci,prd$uci), ncol=2))

colfunc <- colorRampPalette(c("blue", "orange"))
plot(ocos$logNB ~ ocos$Arroyo_Dis, 
     pch=16,
     xlab = "Distance to the Nearest Arroyo (m)",
     ylab= "Log(Number of Branches)", 
     cex=c2,
     cex.lab=c3,
     cex.axis=c2,
     bty="n"
     ) 
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval <- paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(50, 3.0, pval, cex=c1)
title("(b)", adj = 0.05, line = 0, cex.main=c3)

summary(m)
###### Plot C

par(bty = 'n')
boxplot(logNB~Inter_plant_b,
        data=ocos,
        xlab = "Major Interspecific Plant Group",
        ylab= "Log(Number of Branches)",
        col=c(col.alpha( "blue" , alpha = 0.35 ), 
              col.alpha( "red" , alpha = 0.35)),
        border=c("grey28", "grey28"), # grey30 # darkblue, red
        names=c("Cactus", "Shrub"),
     cex=c2,
     cex.lab=c3,
     cex.axis=c2
)
title("(c)", adj = 0.05, line = 0, cex.main=c3)
```

## Nearest Neighbor

```{r fig.width=6, fig.height=2.7}
par(mfrow=c(1,2))

###### Plot A

d = ocos_baj
x=d[,"Elevation"]
y=d[,"logIntraD"] 

m <- lm(y ~ x, data=d)
x.seq = seq(min(x) - sd(x), max(x) + 2*sd(x), length.out=100)

prd <- data.frame(x=x.seq)
err <- predict(m, newdata = prd, se.fit = TRUE)
prd$lci <- err$fit - 1.96 * err$se.fit
prd$fit <- err$fit
prd$uci <- err$fit + 1.96 * err$se.fit
mu_ci <- t(matrix(c(prd$lci,prd$uci), ncol=2))

plot(ocos_baj$logIntraD ~ ocos_baj$Elevation, 
     pch=(16),
     xlab = "Elevation (m)",
     ylab= "Log(Distance to Nearest Neighbor) (m)", 
     cex=1.3,
     cex.lab=1.5,
     cex.axis=1.3,
     bty="n",
     xlim=c(520,600),
     ylim=c(0,3.5)
     ) 
abline(m, lty=2)
 
shade(mu_ci, lim = prd$x)
pval <- paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(560, 3, pval, cex=c1)
title("(a)", adj = 0.05, line = 0, cex.main=c3)

###### Plot B

d = ocos_baj
x=d[,"Number_Branches"]
y=d[,"logIntraD"] 

m <- lm(y ~ x, data=d)
x.seq = seq(min(x) - sd(x), max(x) + sd(x), length.out=100)

prd <- data.frame(x=x.seq) 
err <- predict(m, newdata = prd, se.fit = TRUE)
prd$lci <- err$fit - 1.96 * err$se.fit
prd$fit <- err$fit
prd$uci <- err$fit + 1.96 * err$se.fit
mu_ci <- t(matrix(c(prd$lci,prd$uci), ncol=2))

colfunc <- colorRampPalette(c("grey", "black"))
plot(ocos_baj$logIntraD ~ ocos_baj$Number_Branches, 
     col=colfunc(20)[as.factor(ocos_baj$Inter_Dis)], 
     pch=(16),
     xlab = "Number of Branches",
     ylab= "Log(Distance to Nearest Neighbor) (m)", 
     cex=1.3,
     cex.lab=1.5,
     cex.axis=1.3,
     bty="n",
     xlim=c(10,60),
     ylim=c(0,3)
     ) 
legend(40, 1.5,
       legend = c("0-11", "11-22", "22-33", "33-44", "44-55"),
       col= c(colfunc(20)[1], colfunc(20)[5], colfunc(20)[9], colfunc(20)[13], colfunc(20)[20]),
       #bty="n",
       pch = c(16),
       cex=1.2,
       title="Interspecific Distance")
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval <- paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(32, 1.3, pval, cex=c1)
title("(b)", adj = 0.05, line = 0, cex.main=c3)
```

